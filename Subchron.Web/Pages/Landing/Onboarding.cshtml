@page
@model Subchron.Web.Pages.Landing.OnboardingModel
@{
    ViewData["Title"] = "Onboarding";
    Layout = "_LayoutLogin";
}

<div class="w-full max-w-md">

    <!-- Logo -->
    <div class="flex justify-center">
        <a asp-page="/Index" class="inline-block">
            <img src="~/images/logo/logo.png" alt="Subchron" class="h-12 w-auto object-contain" />
        </a>
    </div>

    <!-- Title -->
    <h1 class="mt-8 text-center text-2xl font-bold text-slate-900 dark:text-white">
        Setup your workspace
    </h1>
    <p class="mt-2 text-center text-sm text-slate-600 dark:text-slate-300">
        Configure organization defaults and attendance rules.
    </p>

    <!-- Card -->
    <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-8 shadow-lg ring-1 ring-slate-900/5
                dark:border-slate-700 dark:bg-slate-800 dark:ring-white/10">

        <!-- Step text -->
        <p class="mb-4 text-center text-sm text-slate-600 dark:text-slate-300">
            Step <span id="stepText" class="font-semibold text-subgreen-600 dark:text-subgreen-400">1</span> of 3
        </p>

        <!-- Step header -->
        <div class="space-y-4">
            <div class="flex items-start justify-between gap-4">
                <div class="min-w-0">
                    <p id="stepTitle" class="text-base font-semibold text-slate-900 dark:text-white">
                        Basics
                    </p>
                    <p id="stepSubtitle" class="mt-1 text-sm text-slate-600 dark:text-slate-300">
                        Set timezone and currency defaults.
                    </p>
                </div>

                <!-- step indicator (dots) -->
                <div class="flex flex-none items-center gap-2 pt-1">
                    <span id="dot1" class="h-2.5 w-2.5 rounded-full bg-subgreen-500"></span>
                    <span id="dot2" class="h-2.5 w-2.5 rounded-full bg-slate-300 dark:bg-slate-600"></span>
                    <span id="dot3" class="h-2.5 w-2.5 rounded-full bg-slate-300 dark:bg-slate-600"></span>
                </div>
            </div>

            <!-- Progress bar -->
            <div class="h-2 w-full overflow-hidden rounded-full bg-slate-100 dark:bg-slate-900/60">
                <div id="progressBar"
                     class="h-full rounded-full bg-gradient-to-r from-subgreen-500 to-subgreen-600 transition-all duration-500 ease-in-out"
                     style="width: 33%;"></div>
            </div>
        </div>

        <!-- Form -->
        <form class="mt-8 space-y-8">

            <!-- STEP 1: Basics -->
            <section id="step1" class="space-y-5">

                <div>
                    <label class="block text-xs font-medium text-slate-600 dark:text-slate-300">
                        Timezone <span style="color:#f01e2c;">*</span>
                    </label>
                    <select id="timezone" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm text-slate-900 shadow-sm
                               transition outline-none
                               focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500/30
                               dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100
                               dark:focus:border-subgreen-400 dark:focus:ring-subgreen-400/30">
                        <option selected>Asia/Manila</option>
                        <option>Asia/Singapore</option>
                        <option>Asia/Tokyo</option>
                        <option>UTC</option>
                    </select>
                    <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
                        Used for attendance timestamps and reports.
                    </p>
                </div>

                <div>
                    <label class="block text-xs font-medium text-slate-600 dark:text-slate-300">
                        Currency <span style="color:#f01e2c;">*</span>
                    </label>
                    <select id="currency" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm text-slate-900 shadow-sm
                               transition outline-none
                               focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500/30
                               dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100
                               dark:focus:border-subgreen-400 dark:focus:ring-subgreen-400/30">
                        <option selected>PHP</option>
                        <option>USD</option>
                        <option>SGD</option>
                        <option>JPY</option>
                    </select>
                    <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
                        For future payroll/export formatting.
                    </p>
                </div>

                <!-- Next (right aligned) -->
                <div class="flex justify-end pt-2">
                    <button id="btnNextStep1" type="button" style="cursor:pointer;"
                            class="rounded-lg bg-gradient-to-r from-subgreen-500 to-subgreen-600 px-6 py-2.5
                                   text-sm font-semibold text-white shadow-md transition-all duration-200
                                   hover:scale-105 hover:from-subgreen-600 hover:to-subgreen-700
                                   focus:ring-2 focus:ring-subgreen-500 focus:ring-offset-2 focus:outline-none
                                   dark:focus:ring-subgreen-400 dark:focus:ring-offset-slate-900">
                        Next
                    </button>
                </div>

            </section>

            <!-- STEP 2: Attendance -->
            <section id="step2" class="hidden space-y-5">

                <div>
                    <label class="block text-xs font-medium text-slate-600 dark:text-slate-300">
                        Attendance Mode <span style="color:#f01e2c;">*</span>
                    </label>
                    <select id="attendanceMode" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm text-slate-900 shadow-sm
                               transition outline-none
                               focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500/30
                               dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100
                               dark:focus:border-subgreen-400 dark:focus:ring-subgreen-400/30">
                        <option selected>QR</option>
                        <option>BioGeo</option>
                        <option>Hybrid</option>
                    </select>
                    <p class="mt-2 text-xs text-slate-500 dark:text-slate-400">
                        Hybrid allows QR + BioGeo depending on employee type/location.
                    </p>
                </div>

                <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 dark:text-slate-300">
                            Default Grace Minutes
                        </label>
                        <input id="defaultGraceMinutes" type="number" min="0" placeholder="e.g., 10"
                               class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm text-slate-900 shadow-sm
                                      transition outline-none placeholder:text-slate-400
                                      focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500/30
                                      dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100
                                      dark:focus:border-subgreen-400 dark:placeholder:text-slate-500 dark:focus:ring-subgreen-400/30" />
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-slate-600 dark:text-slate-300">
                            Round Rule
                        </label>
                        <select id="roundRule" class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm text-slate-900 shadow-sm
                                   transition outline-none
                                   focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500/30
                                   dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100
                                   dark:focus:border-subgreen-400 dark:focus:ring-subgreen-400/30">
                            <option selected>None</option>
                            <option>5min</option>
                            <option>15min</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-3">
                    <label class="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-200">
                        <input id="allowManualEntry" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-subgreen-600 focus:ring-subgreen-500 dark:border-slate-600 dark:bg-slate-900" />
                        Allow Manual Entry
                    </label>

                    <label class="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-200">
                        <input id="requireGeo" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-subgreen-600 focus:ring-subgreen-500 dark:border-slate-600 dark:bg-slate-900" />
                        Require Geo
                    </label>

                    <label class="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-200">
                        <input id="inforceGeoence" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-subgreen-600 focus:ring-subgreen-500 dark:border-slate-600 dark:bg-slate-900" />
                        Enforce Geofence
                    </label>
                </div>

            </section>

            <!-- STEP 3: Modules -->
            <section id="step3" class="hidden space-y-5">

                <div class="space-y-3">
                    <label class="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-200">
                        <input id="otEnabled" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-subgreen-600 focus:ring-subgreen-500 dark:border-slate-600 dark:bg-slate-900" />
                        OT Enabled
                    </label>

                    <div id="otFields" class="hidden space-y-4">
                        <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                            <div>
                                <label class="block text-xs font-medium text-slate-600 dark:text-slate-300">
                                    OT Threshold Hours
                                </label>
                                <input id="otThresholdHours" type="number" step="0.25" min="0" placeholder="e.g., 8"
                                       class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm text-slate-900 shadow-sm
                                              transition outline-none placeholder:text-slate-400
                                              focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500/30
                                              dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100
                                              dark:focus:border-subgreen-400 dark:placeholder:text-slate-500 dark:focus:ring-subgreen-400/30" />
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-slate-600 dark:text-slate-300">
                                    OT Max Hours/Day (optional)
                                </label>
                                <input id="otMaxHoursPerDay" type="number" step="0.25" min="0" placeholder="e.g., 4"
                                       class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-sm text-slate-900 shadow-sm
                                              transition outline-none placeholder:text-slate-400
                                              focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500/30
                                              dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100
                                              dark:focus:border-subgreen-400 dark:placeholder:text-slate-500 dark:focus:ring-subgreen-400/30" />
                            </div>
                        </div>

                        <label class="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-200">
                            <input id="outApprovalRequired" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-subgreen-600 focus:ring-subgreen-500 dark:border-slate-600 dark:bg-slate-900" />
                            OT Approval Required
                        </label>
                    </div>

                    <label class="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-200">
                        <input id="leaveEnabled" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-subgreen-600 focus:ring-subgreen-500 dark:border-slate-600 dark:bg-slate-900" />
                        Leave Enabled
                    </label>

                    <label class="flex items-center gap-3 text-sm text-slate-700 dark:text-slate-200">
                        <input id="leaveApprovalRequired" type="checkbox" class="h-4 w-4 rounded border-slate-300 text-subgreen-600 focus:ring-subgreen-500 dark:border-slate-600 dark:bg-slate-900" />
                        Leave Approval Required
                    </label>
                </div>

                <p class="text-xs text-subgreen-600 dark:text-subgreen-400">
                    Trial starts after setup — no credit card required.
                </p>

            </section>

            <!-- Actions (Step 2-3 only) -->
            <div class="pt-4">
                <div id="actionsRow23" class="flex hidden items-center justify-between gap-3">

                    <button id="btnBack" type="button" style="cursor:pointer;"
                            class="rounded-lg border border-slate-300 bg-white px-6 py-2.5
                                   text-sm font-semibold text-slate-700 transition-all duration-200
                                   hover:bg-slate-50
                                   focus:ring-2 focus:ring-slate-300 focus:ring-offset-2 focus:outline-none
                                   dark:border-slate-600 dark:bg-slate-900 dark:text-slate-200 dark:hover:bg-slate-800
                                   dark:focus:ring-slate-600 dark:focus:ring-offset-slate-900">
                        Back
                    </button>

                    <div class="flex items-center gap-3">
                        <button id="btnNext" type="button" style="cursor:pointer;"
                                class="rounded-lg bg-gradient-to-r from-subgreen-500 to-subgreen-600 px-6 py-2.5
                                       text-sm font-semibold text-white shadow-md transition-all duration-200
                                       hover:scale-105 hover:from-subgreen-600 hover:to-subgreen-700
                                       focus:ring-2 focus:ring-subgreen-500 focus:ring-offset-2 focus:outline-none
                                       dark:focus:ring-subgreen-400 dark:focus:ring-offset-slate-900">
                            Next
                        </button>

                        <button id="btnFinish" type="button"
                                class="hidden rounded-lg bg-gradient-to-r from-subgreen-500 to-subgreen-600 px-6 py-2.5
                                       text-sm font-semibold text-white shadow-md transition-all duration-200
                                       hover:scale-105 hover:from-subgreen-600 hover:to-subgreen-700
                                       focus:ring-2 focus:ring-subgreen-500 focus:ring-offset-2 focus:outline-none
                                       dark:focus:ring-subgreen-400 dark:focus:ring-offset-slate-900">
                            Finish Setup
                        </button>

                        <div id="onboardingError" class="mt-3 hidden rounded-lg border border-red-200 bg-red-50 p-3 text-xs text-red-700"></div>

                    </div>

                </div>

                <p class="mt-4 text-center text-xs text-slate-500 dark:text-slate-400">
                    You can edit these settings later in Admin → Organization Settings.
                </p>
            </div>

        </form>
    </div>
</div>

<script>
    (function () {
      const apiBaseUrl = '@Model.ApiBaseUrl';
      const params = new URLSearchParams(window.location.search);
      const orgId = params.get("orgId");

      let step = 1;

      const stepText = document.getElementById('stepText');
      const progressBar = document.getElementById('progressBar');
      const stepTitle = document.getElementById('stepTitle');
      const stepSubtitle = document.getElementById('stepSubtitle');

      const dot1 = document.getElementById('dot1');
      const dot2 = document.getElementById('dot2');
      const dot3 = document.getElementById('dot3');

      const s1 = document.getElementById('step1');
      const s2 = document.getElementById('step2');
      const s3 = document.getElementById('step3');

      const btnNextStep1 = document.getElementById('btnNextStep1');
      const actionsRow23 = document.getElementById('actionsRow23');
      const btnBack = document.getElementById('btnBack');
      const btnNext = document.getElementById('btnNext');
      const btnFinish = document.getElementById('btnFinish');

      const otEnabled = document.getElementById('otEnabled');
      const otFields = document.getElementById('otFields');

      otEnabled.addEventListener('change', function () {
        otFields.classList.toggle('hidden', !otEnabled.checked);
      });

      function setDotActive(dot) { dot.className = "h-2.5 w-2.5 rounded-full bg-subgreen-500"; }
      function setDotInactive(dot) { dot.className = "h-2.5 w-2.5 rounded-full bg-slate-300 dark:bg-slate-600"; }
      function setProgress(percent) { progressBar.style.width = percent + "%"; }

      function showError(msg) {
        const el = document.getElementById('onboardingError');
        if (!el) return;
        el.textContent = msg || 'Something went wrong.';
        el.classList.remove('hidden');
      }

      function render() {
        s1.classList.toggle('hidden', step !== 1);
        s2.classList.toggle('hidden', step !== 2);
        s3.classList.toggle('hidden', step !== 3);

        stepText.textContent = String(step);

        if (step === 1) setProgress(33);
        if (step === 2) setProgress(66);
        if (step === 3) setProgress(100);

        if (step === 1) {
          stepTitle.textContent = "Basics";
          stepSubtitle.textContent = "Set timezone and currency defaults.";
        } else if (step === 2) {
          stepTitle.textContent = "Attendance Rules";
          stepSubtitle.textContent = "Define mode, rounding, and geo requirements.";
        } else {
          stepTitle.textContent = "Modules";
          stepSubtitle.textContent = "Enable overtime and leave policies.";
        }

        step === 1 ? setDotActive(dot1) : setDotInactive(dot1);
        step === 2 ? setDotActive(dot2) : setDotInactive(dot2);
        step === 3 ? setDotActive(dot3) : setDotInactive(dot3);

        btnNextStep1.classList.toggle('hidden', step !== 1);
        actionsRow23.classList.toggle('hidden', step === 1);

        btnNext.classList.toggle('hidden', step === 3);
        btnFinish.classList.toggle('hidden', step !== 3);
      }

      btnNextStep1.addEventListener('click', function () {
        step = 2;
        render();
      });

      btnNext.addEventListener('click', function () {
        if (step < 3) step++;
        render();
      });

      btnBack.addEventListener('click', function () {
        if (step > 1) step--;
        render();
      });

      btnFinish.addEventListener('click', async function () {
        if (!orgId) return showError("Missing orgId in URL.");

        const payload = {
          timezone: document.getElementById('timezone')?.value || "Asia/Manila",
          currency: document.getElementById('currency')?.value || "PHP",
          attendanceMode: document.getElementById('attendanceMode')?.value || "QR",
          allowManualEntry: document.getElementById('allowManualEntry')?.checked || false,
          requireGeo: document.getElementById('requireGeo')?.checked || false,
          enforceGeofence: document.getElementById('enforceGeofence')?.checked || false,
          defaultGraceMinutes: parseInt(document.getElementById('defaultGraceMinutes')?.value || "0", 10),
          roundRule: document.getElementById('roundRule')?.value || "None",
          otEnabled: document.getElementById('otEnabled')?.checked || false,
          otThresholdHours: parseFloat(document.getElementById('otThresholdHours')?.value || "0"),
          otMaxHoursPerDay: document.getElementById('otMaxHoursPerDay')?.value
            ? parseFloat(document.getElementById('otMaxHoursPerDay').value)
            : null,
          otApprovalRequired: document.getElementById('otApprovalRequired')?.checked || false,
          leaveEnabled: document.getElementById('leaveEnabled')?.checked || false,
          leaveApprovalRequired: document.getElementById('leaveApprovalRequired')?.checked || false
        };

        const res = await fetch(`${apiBaseUrl}/api/organizations/${orgId}/settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok || !data.ok) return showError(data.message || 'Failed to save settings.');

        window.location.replace('/App/Dashboard');
      });

      render();
    })();
</script>
