@page
@model Subchron.Web.Pages.Auth.VerifyEmailModel
@{
    ViewData["Title"] = "Verify Email";
    Layout = "_LayoutLogin";
}

<div class="w-full max-w-md">

    <!-- Logo -->
    <div class="flex justify-center">
        <a asp-page="/Index" class="inline-block">
            <img src="~/images/logo/logo.png" alt="Subchron" class="h-12 w-auto object-contain" />
        </a>
    </div>

    <h1 class="mt-8 text-center text-2xl font-bold text-slate-900 dark:text-white">
        Verify your email
    </h1>

    <div id="verifyCard" class="mt-6 rounded-2xl border border-slate-200 bg-white p-8 shadow-lg ring-1 ring-slate-900/5
                dark:border-slate-700 dark:bg-slate-800 dark:ring-white/10"
         data-email="@Model.Email" data-plan-id="@Model.PlanId" data-api-base-url="@Model.ApiBaseUrl">

        <div class="mx-auto flex h-14 w-14 items-center justify-center rounded-full bg-subgreen-100 dark:bg-subgreen-900/30 dark:ring-1 dark:ring-subgreen-700">
            <svg class="h-7 w-7 text-subgreen-600 dark:text-subgreen-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 8v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8m18 0-8.029-4.46a2 2 0 0 0-1.942 0L3 8m18 0-9 6.5L3 8"/>
            </svg>
        </div>

        <div class="mt-6 text-center">
            <p class="text-sm text-slate-600 dark:text-slate-300">We sent a 6-digit code to</p>
            <p id="displayEmail" class="mt-2 text-base font-semibold break-words text-subgreen-600 dark:text-subgreen-300">@Model.Email</p>
            <p class="mt-3 text-sm text-slate-500 dark:text-slate-400">Enter the code below. It expires in 15 minutes.</p>
        </div>

        <!-- Code input -->
        <div class="mt-6">
            <label for="code" class="block text-xs font-medium text-slate-600 dark:text-slate-300">Verification code</label>
            <input id="code" type="text" inputmode="numeric" maxlength="6" pattern="[0-9]*" autocomplete="one-time-code"
                   placeholder="000000"
                   class="mt-2 w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-center text-lg tracking-[0.5em] text-slate-900
                          focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500
                          dark:border-slate-600 dark:bg-slate-900 dark:text-slate-100 dark:focus:border-subgreen-400 dark:focus:ring-subgreen-400" />
            <p id="codeError" class="mt-2 hidden text-xs text-red-600 dark:text-red-400"></p>
        </div>

        <div class="mt-6 flex flex-col gap-3">
            <button type="button" id="btnVerify"
                    class="w-full rounded-lg bg-subgreen-500 py-3 text-center text-sm font-semibold text-white shadow-md transition
                           hover:bg-subgreen-600 focus:ring-2 focus:ring-subgreen-500 focus:ring-offset-2 disabled:opacity-70 disabled:cursor-not-allowed">
                Verify and continue
            </button>
            <button type="button" id="btnResend"
                    class="w-full rounded-lg border-2 border-slate-300 bg-transparent py-3 text-center text-sm font-semibold text-slate-700 transition
                           hover:bg-slate-50 dark:border-slate-600 dark:bg-transparent dark:text-slate-200 dark:hover:bg-slate-800 disabled:opacity-70">
                Resend code
            </button>
            <a asp-page="/Auth/Signup" asp-route-planId="@Model.PlanId"
               class="text-center text-sm font-semibold text-subgreen-600 hover:text-subgreen-700 dark:text-subgreen-400 dark:hover:text-subgreen-300">
                Change email
            </a>
        </div>
    </div>

    <p class="mt-8 text-center text-sm text-slate-600 dark:text-slate-300">
        Already have an account?
        <a asp-page="/Auth/Login" class="font-semibold text-subgreen-600 hover:text-subgreen-700 dark:text-subgreen-400 dark:hover:text-subgreen-300">Sign in</a>
    </p>
</div>

@section Scripts {
    <script>
        (function () {
            var card = document.getElementById('verifyCard');
            var apiBaseUrl = (card && card.getAttribute('data-api-base-url')) || '';
            apiBaseUrl = apiBaseUrl.trim();
            if (!apiBaseUrl) apiBaseUrl = window.location.origin;
            apiBaseUrl = apiBaseUrl.replace(/\/$/, '');
            var email = (card && card.getAttribute('data-email')) || '';
            var planId = (card && card.getAttribute('data-plan-id')) || '';

            var codeEl = document.getElementById('code');
            var codeError = document.getElementById('codeError');
            var btnVerify = document.getElementById('btnVerify');
            var btnResend = document.getElementById('btnResend');

            function showError(msg) {
                if (!codeError) return;
                codeError.textContent = msg || '';
                codeError.classList.toggle('hidden', !msg);
            }

            function setLoading(loading) {
                if (btnVerify) {
                    btnVerify.disabled = loading;
                    btnVerify.textContent = loading ? 'Verifying...' : 'Verify and continue';
                }
            }

            function redirectToSignupDetails() {
                var url = '/Landing/SignupDetails?provider=email&email=' + encodeURIComponent(email) + '&verified=1';
                if (planId) url += '&planId=' + encodeURIComponent(planId);
                window.location.replace(url);
            }

            function verify() {
                var raw = (codeEl && codeEl.value) ? codeEl.value : '';
                var code = raw.trim().replace(/\s/g, '');
                showError('');
                if (code.length === 0) {
                    showError('Please enter the 6-digit verification code.');
                    if (codeEl) codeEl.focus();
                    return;
                }
                if (code.length !== 6 || !/^\d{6}$/.test(code)) {
                    showError('Please enter all 6 digits (numbers only).');
                    if (codeEl) codeEl.focus();
                    return;
                }
                setLoading(true);
                var reqUrl = apiBaseUrl + '/api/auth/verify-email-code';
                fetch(reqUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email, code: code })
                })
                    .then(function (r) {
                        return r.text().then(function (text) {
                            var data = null;
                            try { data = text ? JSON.parse(text) : null; } catch (_) { }
                            if (!r.ok) {
                                var msg = (data && data.message) ? data.message : (r.status === 404 ? 'API not found. Check ApiBaseUrl in appsettings.' : 'Verification failed.');
                                throw new Error(msg);
                            }
                            return data;
                        });
                    })
                    .then(function (data) {
                        setLoading(false);
                        if (data && data.ok) {
                            redirectToSignupDetails();
                            return;
                        }
                        showError(data && data.message ? data.message : 'Invalid or expired code. Please try again or request a new code.');
                    })
                    .catch(function (err) {
                        setLoading(false);
                        showError(err && err.message ? err.message : 'Network error. Please ensure the API is running and try again.');
                    });
            }

            function resend() {
                showError('');
                if (btnResend) btnResend.disabled = true;
                var reqUrl = apiBaseUrl + '/api/auth/send-verification-code';
                fetch(reqUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: email })
                })
                    .then(function (r) { return r.json(); })
                    .then(function (data) {
                        if (btnResend) btnResend.disabled = false;
                        if (data && data.ok) {
                            showError('');
                            alert('A new code was sent to your email.');
                        } else {
                            showError(data && data.message ? data.message : 'Could not resend code.');
                        }
                    })
                    .catch(function () {
                        if (btnResend) btnResend.disabled = false;
                        showError('Network error.');
                    });
            }

            if (btnVerify) btnVerify.addEventListener('click', verify);
            if (btnResend) btnResend.addEventListener('click', resend);
            if (codeEl) codeEl.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); verify(); } });
        })();
    </script>
}
