<div id="tab-profile" class="tab-content mx-auto w-full max-w-6xl px-4 py-6">

    <div class="mb-6 border-b border-gray-200 pb-4 dark:border-gray-700">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Organization Profile</h1>
        <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">Manage your organization's details and branding.</p>
    </div>

    <form id="org-profile-form" onsubmit="event.preventDefault(); saveChanges();">

        <div id="orgProfileError" class="mb-4 hidden rounded-md border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700"></div>

        <div class="relative mb-8 overflow-hidden rounded-3xl border border-gray-200 bg-gradient-to-br from-white via-emerald-50/50 to-white p-6 shadow-sm dark:border-gray-700 dark:from-slate-900 dark:via-slate-900 dark:to-slate-900">
            <div class="pointer-events-none absolute inset-y-0 right-0 w-1/2 opacity-60">
                <div class="h-full bg-[radial-gradient(circle_at_top,_rgba(16,185,129,0.08),_transparent_60%)]"></div>
            </div>
            <div class="relative z-10 flex flex-col gap-8 md:flex-row md:items-center">
                <div class="relative h-32 w-32 flex-shrink-0 drop-shadow-sm">
                    <div class="group flex h-full w-full items-center justify-center overflow-hidden rounded-2xl border border-dashed border-emerald-200 bg-white/80 transition-colors hover:border-emerald-400 dark:border-emerald-500/40 dark:bg-slate-800">
                        <svg id="profile-placeholder" class="h-12 w-12 text-emerald-400/70 dark:text-emerald-500" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M24 20.993V24H0v-2.996A14.977 14.977 0 0112.004 15c4.904 0 9.26 2.354 11.996 5.993zM16.002 8.999a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                        <img id="profile-preview" src="#" alt="Logo" class="hidden h-full w-full object-cover" />
                    </div>
                    <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="previewImage(event)" />
                </div>

                <div class="flex h-auto flex-1 flex-col justify-center gap-4">
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-[0.3em] text-emerald-500">Org Identity</p>
                        <input type="text"
                               id="company-name"
                               name="company-name"
                               value=""
                               disabled
                               class="placeholder-gray-400 w-full border-0 bg-transparent p-0 text-3xl font-bold text-gray-900 transition-all duration-200 focus:ring-0 focus:outline-none enabled:border-b-2 enabled:border-emerald-500 enabled:pb-1 disabled:cursor-text dark:text-white"
                               placeholder="Company Name">
                        <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Customize how your organization appears across invites, portals, and employee experiences.</p>
                    </div>

                    <div class="flex flex-wrap gap-4">
                        <button type="button" onclick="document.getElementById('file-upload').click()"
                                class="inline-flex items-center gap-1.5 rounded-xl border border-emerald-400/80 bg-transparent px-4 py-2 text-sm font-semibold text-emerald-600 transition hover:-translate-y-0.5 hover:border-emerald-500 hover:text-emerald-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-emerald-500/60 dark:border-emerald-500/70 dark:text-emerald-300">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                            </svg>
                            Change Logo
                        </button>

                        <button type="button" id="edit-btn" onclick="enableEditMode()" class="inline-flex items-center gap-2 rounded-xl border border-transparent bg-emerald-500/10 px-4 py-2 text-sm font-semibold text-emerald-700 transition hover:bg-emerald-500/20 dark:text-emerald-300">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-4 w-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                            </svg>
                            Edit Profile
                        </button>
                    </div>

                    <div class="flex flex-wrap gap-3 text-xs font-medium text-gray-500 dark:text-gray-400">
                        <span class="inline-flex items-center gap-2 rounded-full border border-emerald-100 bg-white/70 px-3 py-1 text-emerald-600 dark:border-emerald-500/30 dark:bg-slate-800/70">
                            <span class="h-2 w-2 rounded-full bg-emerald-500"></span>
                            Brand-ready assets
                        </span>
                        <span class="inline-flex items-center gap-2 rounded-full border border-gray-200 bg-white/60 px-3 py-1 dark:border-gray-700 dark:bg-slate-800/70">
                            <svg class="h-3.5 w-3.5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            Ensure timezone, currency & HQ info stay fresh
                        </span>
                    </div>
                </div>
            </div>
        </div>

        <hr class="mb-8 border-gray-200 dark:border-gray-700" />

        <div class="space-y-6">

            <div>
                <label class="mb-2 block text-sm font-semibold text-gray-800 dark:text-white">Headquarters Address</label>
                <div class="grid grid-cols-1 gap-4 md:grid-cols-12">
                    <div class="md:col-span-12 address-autocomplete">
                        <label for="orgAddressLine1" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Street Address</label>
                        <div class="relative">
                            <div class="form-input-icon">
                                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5a3 3 0 11-6 0 3 3 0 016 0z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 10.5c0 7.142-7.5 11.25-7.5 11.25S4.5 17.642 4.5 10.5a7.5 7.5 0 1115 0z" />
                                </svg>
                            </div>
                            <input type="text" id="orgAddressLine1" disabled placeholder="Street Address" class="form-input-custom has-icon" value="">
                            <div id="orgAddressSuggestions" class="absolute left-0 right-0 top-full z-20 mt-1 hidden max-h-60 overflow-auto rounded-lg border border-slate-200 bg-white shadow-lg dark:border-slate-600 dark:bg-slate-800"></div>
                        </div>
                    </div>

                    <div class="md:col-span-3">
                        <label for="orgCity" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">City</label>
                        <input type="text" id="orgCity" disabled placeholder="City" class="form-input-custom" value="">
                    </div>

                    <div class="md:col-span-3">
                        <label for="orgState" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">State / Province</label>
                        <input type="text" id="orgState" disabled placeholder="State/Province" class="form-input-custom" value="">
                    </div>

                    <div class="md:col-span-3">
                        <label for="orgPostal" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Postal Code</label>
                        <input type="text" id="orgPostal" disabled placeholder="Postal Code" class="form-input-custom" value="">
                    </div>

                    <div class="md:col-span-3">
                        <label for="orgCountry" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Country</label>
                        <select id="orgCountry" disabled class="form-input-custom">
                            <option selected>Philippines</option>
                            <option>United States</option>
                            <option>Canada</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <label class="mb-2 block text-sm font-semibold text-gray-800 dark:text-white">Contact Information</label>
                <div class="grid grid-cols-1 gap-4 md:grid-cols-2">

                    <div>
                        <label for="orgContactEmail" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Contact Email</label>
                        <div class="relative">
                            <div class="form-input-icon">
                                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                                </svg>
                            </div>
                            <input type="email" id="orgContactEmail" disabled placeholder="Contact Email" class="form-input-custom has-icon" value="">
                        </div>
                    </div>

                    <div>
                        <label for="orgContactPhone" class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Contact Phone</label>
                        <div class="relative">
                            <div class="form-input-icon">
                                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 002.25-2.25v-1.372c0-.516-.351-.966-.852-1.091l-4.423-1.106c-.44-.11-.902.055-1.173.417l-.97 1.293c-.282.376-.769.542-1.21.38a12.035 12.035 0 01-7.143-7.143c-.162-.441.004-.928.38-1.21l1.293-.97c.363-.271.527-.734.417-1.173L6.963 3.102a1.125 1.125 0 00-1.091-.852H4.5A2.25 2.25 0 002.25 4.5v2.25z" />
                                </svg>
                            </div>
                            <input type="text" id="orgContactPhone" disabled placeholder="Phone Number" class="form-input-custom has-icon" value="">
                        </div>
                    </div>

                </div>
            </div>

            <div>
                <label class="mb-2 block text-sm font-semibold text-gray-800 dark:text-white">Regional Settings</label>
                <div class="grid grid-cols-1 gap-4 md:grid-cols-2">

                    <div>
                        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Timezone</label>
                        <div class="relative">
                            <div class="form-input-icon">
                                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <select disabled class="form-input-custom has-icon">
                                <option>Asia/Manila (GMT+8)</option>
                                <option>Asia/Tokyo (GMT+9)</option>
                                <option>America/New_York (GMT-5)</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="mb-1 block text-xs font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">Currency</label>
                        <div class="relative">
                            <div class="form-input-icon">
                                <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 a 0 0118 0z" />
                                </svg>
                            </div>
                            <select disabled class="form-input-custom has-icon">
                                <option>PHP - Philippine Peso</option>
                                <option>USD - US Dollar</option>
                                <option>JPY - Japanese Yen</option>
                            </select>
                        </div>
                    </div>

                </div>
            </div>

            <div id="action-buttons" class="animate-fade-in hidden">
                <hr class="mt-8 mb-4 border-gray-200 dark:border-gray-700" />

                <div class="flex items-center justify-end gap-x-4">
                    <button type="button" onclick="cancelEditMode()" class="text-sm leading-6 font-semibold text-gray-800 transition-colors hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
                        Cancel
                    </button>
                    <button type="submit" id="orgProfileSaveBtn" class="btn-primary">
                        Save Changes
                    </button>
                </div>
            </div>

        </div>
    </form>
</div>

<style>
    /* Base Input Style */
    .form-input-custom {
        display: block;
        width: 100%;
        border-radius: 0.375rem;
        padding-top: 0.625rem;
        padding-bottom: 0.625rem;
        padding-right: 0.75rem;
        padding-left: 0.75rem;
        font-size: 0.875rem;
        line-height: 1.25rem;
        color: #111827;
        border: 1px solid #d1d5db;
        background-color: #ffffff;
        transition: all 0.2s;
    }

    .form-input-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        align-items: center;
        pointer-events: none;
        color: #9ca3af;
    }

    .form-input-custom.input-error,
    .input-error.form-input-custom {
        border-color: #f87171 !important;
        box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.35);
    }

        /* FIX FOR OVERLAP: Forces space for icon */
        .form-input-custom.has-icon {
            padding-left: 3rem !important;
        }

        .form-input-custom:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            --tw-ring-offset-width: 0px;
            --tw-ring-color: #10b981;
            box-shadow: var(--tw-ring-offset-shadow, 0 0 #0000), var(--tw-ring-shadow, 0 0 #0000), var(--tw-shadow);
            border-color: #10b981;
        }

        .form-input-custom:disabled {
            background-color: #f9fafb;
            border-color: #e5e7eb;
            color: #4b5563;
            cursor: not-allowed;
        }

    /* Dark mode overrides */
    .dark .form-input-custom {
        background-color: #1f2937;
        border-color: #4b5563;
        color: #f3f4f6;
    }

        .dark .form-input-custom:focus {
            border-color: #10b981;
            --tw-ring-color: #10b981;
            --tw-ring-offset-color: #1f2937;
        }

        .dark .form-input-custom:disabled {
            background-color: #111827;
            border-color: #374151;
            color: #9ca3af;
        }

    .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(-5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>

<script>
    (function () {
        const form = document.getElementById('org-profile-form');
        if (!form) return;

        const appRoot = document.getElementById('appRoot');
        const apiBase = (appRoot?.getAttribute('data-api-base') || '').trim().replace(/\/$/, '');
        const token = appRoot?.getAttribute('data-access-token') || '';
        if (!apiBase || !token) return;

        const actions = document.getElementById('action-buttons');
        const editBtn = document.getElementById('edit-btn');
        const saveBtn = document.getElementById('orgProfileSaveBtn');
        const companyNameInput = document.getElementById('company-name');
        const previewImg = document.getElementById('profile-preview');
        const placeholder = document.getElementById('profile-placeholder');
        const errorBox = document.getElementById('orgProfileError');

        let profileState = null;
        let isSaving = false;

        const fieldIds = {
            addressLine1: 'orgAddressLine1',
            city: 'orgCity',
            stateProvince: 'orgState',
            postalCode: 'orgPostal',
            country: 'orgCountry',
            contactEmail: 'orgContactEmail',
            contactPhone: 'orgContactPhone'
        };

        const formInputs = Object.fromEntries(Object.entries(fieldIds).map(([key, id]) => [key, document.getElementById(id)]));
        const trackedFields = ['orgName', ...Object.keys(fieldIds)];

        function cleanValue(value) {
            const trimmed = (value ?? '').trim();
            return trimmed.length ? trimmed : null;
        }

        function getInputEl(key) {
            if (key === 'orgName') return companyNameInput;
            return formInputs[key] || null;
        }

        function getInputValue(key) {
            const el = getInputEl(key);
            return el ? el.value.trim() : '';
        }

        function setInputValue(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            el.value = value ?? '';
        }

        function setSelectValue(id, value) {
            const el = document.getElementById(id);
            if (!el) return;
            if (!value) {
                el.selectedIndex = 0;
                return;
            }
            const match = Array.from(el.options).find(opt => (opt.value || opt.text) === value);
            if (match) {
                el.value = match.value || match.text;
                return;
            }
            const opt = document.createElement('option');
            opt.value = value;
            opt.text = value;
            el.appendChild(opt);
            el.value = value;
        }

        function updateLogoPreview(url, orgName) {
            if (!previewImg || !placeholder) return;
            if (url) {
                const bust = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
                previewImg.src = bust;
                previewImg.alt = (orgName || 'Organization') + ' logo';
                previewImg.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                previewImg.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        function mapResponse(data) {
            const billingEmail = (data?.billingEmail ?? '').trim();
            const billingPhone = (data?.billingPhone ?? '').trim();
            const primaryUserEmail = (data?.primaryUserEmail ?? '').trim();
            const contactEmail = (data?.contactEmail ?? '').trim();
            const contactPhone = (data?.contactPhone ?? '').trim();

            return {
                orgId: data?.orgId ?? null,
                orgName: (data?.orgName ?? '').trim(),
                addressLine1: data?.addressLine1 ?? '',
                addressLine2: data?.addressLine2 ?? '',
                city: data?.city ?? '',
                stateProvince: data?.stateProvince ?? '',
                postalCode: data?.postalCode ?? '',
                country: data?.country ?? 'Philippines',
                contactEmail: contactEmail || billingEmail || primaryUserEmail,
                contactPhone: contactPhone || billingPhone,
                billingEmail,
                billingPhone,
                primaryUserEmail,
                logoUrl: data?.logoUrl ?? null
            };
        }

        function hydrateForm(state) {
            if (!state) return;
            if (companyNameInput) companyNameInput.value = state.orgName ?? '';
            setInputValue(fieldIds.addressLine1, state.addressLine1);
            setInputValue(fieldIds.city, state.city);
            setInputValue(fieldIds.stateProvince, state.stateProvince);
            setInputValue(fieldIds.postalCode, state.postalCode);
            setSelectValue(fieldIds.country, state.country ?? 'Philippines');
            setInputValue(fieldIds.contactEmail, state.contactEmail);
            setInputValue(fieldIds.contactPhone, state.contactPhone);
            updateLogoPreview(state.logoUrl, state.orgName);
        }

        function toggleInputs(disabled) {
            const inputs = form.querySelectorAll('input:not(#file-upload), select');
            inputs.forEach(el => {
                if (disabled) el.setAttribute('disabled', 'true');
                else el.removeAttribute('disabled');
            });
        }

        function setSaving(state) {
            isSaving = state;
            if (saveBtn) {
                saveBtn.disabled = state;
                saveBtn.textContent = state ? 'Saving...' : 'Save Changes';
            }
        }

        function showFormError(message) {
            if (!errorBox) return;
            if (message) {
                errorBox.textContent = message;
                errorBox.classList.remove('hidden');
            } else {
                errorBox.textContent = '';
                errorBox.classList.add('hidden');
            }
        }

        function clearFieldErrors() {
            trackedFields.forEach(key => {
                const el = getInputEl(key);
                if (el) {
                    el.classList.remove('input-error');
                    el.removeAttribute('aria-invalid');
                }
            });
        }

        function markFieldError(key) {
            const el = getInputEl(key);
            if (!el) return;
            el.classList.add('input-error');
            el.setAttribute('aria-invalid', 'true');
        }

        function focusField(key) {
            const el = getInputEl(key);
            if (!el) return;
            el.focus({ preventScroll: true });
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function attachFieldListeners() {
            trackedFields.forEach(key => {
                const el = getInputEl(key);
                if (!el) return;
                el.addEventListener('input', () => {
                    el.classList.remove('input-error');
                    el.removeAttribute('aria-invalid');
                    if (errorBox && !errorBox.classList.contains('hidden')) showFormError('');
                });
            });
        }

        function validatePayload(payload) {
            const errors = [];
            const at = String.fromCharCode(64);
            const emailRegex = new RegExp('^[^\\s' + at + ']+' + at + '[^\\s' + at + ']+\\.[^\\s' + at + ']+$');
            if (!payload.orgName) errors.push({ field: 'orgName', message: 'Organization name is required.' });
            if (!payload.contactEmail) errors.push({ field: 'contactEmail', message: 'Contact email is required.' });
            else if (!emailRegex.test(payload.contactEmail)) errors.push({ field: 'contactEmail', message: 'Enter a valid contact email address.' });
            if (!payload.contactPhone) errors.push({ field: 'contactPhone', message: 'Contact phone is required.' });
            else if (payload.contactPhone.replace(/\D/g, '').length < 7) errors.push({ field: 'contactPhone', message: 'Enter a valid contact phone number.' });
            return errors;
        }

        async function loadProfile() {
            try {
                const resp = await fetch(`${apiBase}/api/org-profile/current`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const text = await resp.text();
                let data = null;
                if (text) {
                    try { data = JSON.parse(text); } catch { }
                }
                if (!resp.ok) {
                    const message = data?.message || 'Unable to load organization profile.';
                    window.showToast?.(message, false);
                    return;
                }
                profileState = mapResponse(data);
                hydrateForm(profileState);
            }
            catch {
                window.showToast?.('Unable to load organization profile.', false);
            }
        }

        window.enableEditMode = function enableEditMode() {
            if (!profileState) return;
            toggleInputs(false);
            actions?.classList.remove('hidden');
            editBtn?.classList.add('hidden');
            companyNameInput?.focus();
        };

        window.cancelEditMode = function cancelEditMode() {
            toggleInputs(true);
            actions?.classList.add('hidden');
            editBtn?.classList.remove('hidden');
            clearFieldErrors();
            showFormError('');
            hydrateForm(profileState);
        };

        window.saveChanges = async function saveChanges() {
            if (!profileState || isSaving) return;
            const payload = {
                orgName: getInputValue('orgName'),
                addressLine1: cleanValue(formInputs.addressLine1?.value),
                city: cleanValue(formInputs.city?.value),
                stateProvince: cleanValue(formInputs.stateProvince?.value),
                postalCode: cleanValue(formInputs.postalCode?.value),
                country: cleanValue(formInputs.country?.value),
                contactEmail: cleanValue(formInputs.contactEmail?.value),
                contactPhone: cleanValue(formInputs.contactPhone?.value)
            };

            clearFieldErrors();
            showFormError('');
            const validationErrors = validatePayload(payload);
            if (validationErrors.length) {
                validationErrors.forEach(err => markFieldError(err.field));
                showFormError(validationErrors[0].message);
                focusField(validationErrors[0].field);
                return;
            }

            setSaving(true);
            try {
                const resp = await fetch(`${apiBase}/api/org-profile/current`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const text = await resp.text();
                let data = null;
                if (text) {
                    try { data = JSON.parse(text); } catch { }
                }

                if (!resp.ok) {
                    const message = data?.message || 'Failed to update organization profile.';
                    throw new Error(message);
                }

                profileState = {
                    ...profileState,
                    orgName: payload.orgName,
                    addressLine1: payload.addressLine1 ?? '',
                    city: payload.city ?? '',
                    stateProvince: payload.stateProvince ?? '',
                    postalCode: payload.postalCode ?? '',
                    country: payload.country ?? profileState.country,
                    contactEmail: payload.contactEmail ?? '',
                    contactPhone: payload.contactPhone ?? ''
                };

                hydrateForm(profileState);
                window.showToast?.('Organization profile updated.', true);
                window.dispatchEvent(new CustomEvent('org-branding-updated', { detail: { orgName: payload.orgName } }));
                window.cancelEditMode();
            }
            catch (err) {
                window.showToast?.(err.message || 'Failed to update organization profile.', false);
            }
            finally {
                setSaving(false);
            }
        };

        async function uploadLogo(file) {
            const formData = new FormData();
            formData.append('file', file);

            const resp = await fetch(`${apiBase}/api/org-profile/current/logo`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: formData
            });

            const text = await resp.text();
            let data = null;
            if (text) {
                try { data = JSON.parse(text); } catch { }
            }

            if (!resp.ok) {
                const message = data?.message || 'Logo upload failed.';
                throw new Error(message);
            }

            const url = data?.logoUrl;
            if (!url) throw new Error('Logo upload did not return a URL.');

            profileState = profileState ? { ...profileState, logoUrl: url } : { logoUrl: url };
            updateLogoPreview(url, profileState?.orgName);
            window.showToast?.('Logo updated.', true);
            window.dispatchEvent(new CustomEvent('org-branding-updated', { detail: { logoUrl: url } }));
        }

        window.previewImage = async function previewImage(event) {
            const file = event.target.files?.[0];
            if (!file) return;
            const allowed = ['image/jpeg', 'image/png', 'image/webp', 'image/svg+xml'];
            const type = (file.type || '').toLowerCase();
            if (!allowed.includes(type)) {
                window.showToast?.('Only JPEG, PNG, WebP, or SVG files are allowed.', false);
                event.target.value = '';
                return;
            }
            if (file.size > 5 * 1024 * 1024) {
                window.showToast?.('Logo must be 5 MB or less.', false);
                event.target.value = '';
                return;
            }

            const tempUrl = URL.createObjectURL(file);
            updateLogoPreview(tempUrl, profileState?.orgName);

            try {
                await uploadLogo(file);
            }
            catch (err) {
                window.showToast?.(err.message || 'Logo upload failed.', false);
                updateLogoPreview(profileState?.logoUrl || null, profileState?.orgName);
            }
            finally {
                setTimeout(() => URL.revokeObjectURL(tempUrl), 3000);
            }
        };

        loadProfile();
        attachFieldListeners();
    })();

    // Org profile address autocomplete (LocationIQ) — reuse Add Employee experience
    (function () {
        const addressInput = document.getElementById('orgAddressLine1');
        const suggestions = document.getElementById('orgAddressSuggestions');
        if (!addressInput || !suggestions) return;

        const cityInput = document.getElementById('orgCity');
        const stateInput = document.getElementById('orgState');
        const postalInput = document.getElementById('orgPostal');
        const countryInput = document.getElementById('orgCountry');
        const appRoot = document.getElementById('appRoot');
        const apiBase = (appRoot?.getAttribute('data-api-base') || '').trim().replace(/\/$/, '');

        let debounceTimer = null;
        let abortController = null;
        let activeIndex = -1;

        function buildLocationUrl(query) {
            const path = `/api/location/autocomplete?q=${encodeURIComponent(query)}&limit=6`;
            return apiBase ? `${apiBase}${path}` : path;
        }

        function setActiveSuggestion(index) {
            const options = suggestions.querySelectorAll('button');
            if (!options.length) { activeIndex = -1; return; }

            if (activeIndex >= 0 && options[activeIndex]) {
                options[activeIndex].classList.remove('bg-slate-100', 'dark:bg-slate-700');
            }

            activeIndex = index;
            if (activeIndex >= 0 && options[activeIndex]) {
                options[activeIndex].classList.add('bg-slate-100', 'dark:bg-slate-700');
                options[activeIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function clearSuggestions() {
            suggestions.classList.add('hidden');
            suggestions.innerHTML = '';
            activeIndex = -1;
        }

        function fillAddress(item) {
            addressInput.value = item.addressLine || item.displayName || '';
            if (cityInput) cityInput.value = item.city || '';
            if (stateInput) stateInput.value = item.state || '';
            if (postalInput) postalInput.value = item.postalCode || '';
            if (countryInput) countryInput.value = item.country || 'Philippines';
            clearSuggestions();
        }

        addressInput.addEventListener('input', function () {
            clearTimeout(debounceTimer);
            const query = (this.value || '').trim();
            if (abortController) abortController.abort();
            clearSuggestions();
            if (query.length < 3) return;

            debounceTimer = setTimeout(function () {
                abortController = new AbortController();
                fetch(buildLocationUrl(query), { signal: abortController.signal })
                    .then(r => r.ok ? r.json() : [])
                    .then(data => {
                        if (!Array.isArray(data) || !data.length) { clearSuggestions(); return; }
                        data.forEach((item, idx) => {
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.className = 'w-full px-4 py-2.5 text-left text-sm text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-700';
                            btn.textContent = item.displayName || item.addressLine || 'Address';
                            btn.addEventListener('click', () => fillAddress(item));
                            btn.addEventListener('mouseenter', () => setActiveSuggestion(idx));
                            suggestions.appendChild(btn);
                        });
                        suggestions.classList.remove('hidden');
                        activeIndex = -1;
                    })
                    .catch(err => {
                        if (err?.name === 'AbortError') return;
                        clearSuggestions();
                    });
            }, 320);
        });

        addressInput.addEventListener('keydown', function (e) {
            if (suggestions.classList.contains('hidden')) return;
            const options = suggestions.querySelectorAll('button');
            if (!options.length) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                const next = activeIndex < options.length - 1 ? activeIndex + 1 : 0;
                setActiveSuggestion(next);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prev = activeIndex > 0 ? activeIndex - 1 : options.length - 1;
                setActiveSuggestion(prev);
            } else if (e.key === 'Enter') {
                if (activeIndex >= 0 && options[activeIndex]) {
                    e.preventDefault();
                    options[activeIndex].click();
                }
            } else if (e.key === 'Escape') {
                clearSuggestions();
            }
        });

        document.addEventListener('click', function (e) {
            if (!e.target.closest('.address-autocomplete')) clearSuggestions();
        });
    })();
</script>
