@page
@using Microsoft.AspNetCore.Mvc.ViewFeatures
@model Subchron.Web.Pages.App.Employee.EmployeeManagementModel
@{
    ViewData["Title"] = "Employee Management";
    ViewData["PageTitle"] = "Employee Management";
    Layout = "/Pages/App/Shared/_LayoutAdmin.cshtml";
}

<div id="employeePageHost" class="mx-auto" aria-busy="true">

    <!-- Skeleton -->
    <div id="employeeSkeleton" class="space-y-6 animate-pulse">
        <div class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div class="h-8 w-56 rounded-lg bg-slate-200 dark:bg-slate-700"></div>
            <div class="flex items-center gap-3">
                <div class="h-10 w-28 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
                <div class="h-10 w-32 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
            </div>
        </div>
        <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">
            <div class="grid grid-cols-2 border-b border-slate-100 lg:grid-cols-4 dark:border-slate-800">
                <div class="p-4"><div class="h-3 w-20 rounded bg-slate-200 dark:bg-slate-700"></div><div class="mt-2 h-6 w-16 rounded bg-slate-200 dark:bg-slate-700"></div></div>
                <div class="p-4"><div class="h-3 w-24 rounded bg-slate-200 dark:bg-slate-700"></div><div class="mt-2 h-6 w-16 rounded bg-slate-200 dark:bg-slate-700"></div></div>
                <div class="p-4"><div class="h-3 w-24 rounded bg-slate-200 dark:bg-slate-700"></div><div class="mt-2 h-6 w-16 rounded bg-slate-200 dark:bg-slate-700"></div></div>
                <div class="p-4"><div class="h-3 w-20 rounded bg-slate-200 dark:bg-slate-700"></div><div class="mt-2 h-6 w-16 rounded bg-slate-200 dark:bg-slate-700"></div></div>
            </div>
            <div class="space-y-3 p-4">
                <div class="h-10 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
                <div class="h-10 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
                <div class="h-10 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
                <div class="h-10 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
                <div class="h-10 rounded-xl bg-slate-200 dark:bg-slate-700"></div>
            </div>
        </div>
    </div>

    <!-- Real content -->
    <div id="employeeContent" class="hidden">

        <div class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <div>
                <h1 class="text-xl font-bold tracking-tight text-subgreen-500 dark:text-white sm:text-2xl">Employee Directory</h1>
            </div>

            <div class="flex items-center gap-3 w-full justify-end sm:w-auto sm:justify-end">
                <a asp-page="/App/Archive/Archive" aria-label="View archive" class="btn-secondary px-3 sm:px-4 py-2.5">
                    <svg class="mr-0 sm:mr-2 h-4 w-4 text-gray-500 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
                    </svg>
                    <span class="hidden sm:inline">View Archive</span>
                </a>

                <a asp-page="/App/Employee/Add" aria-label="Add employee" class="btn-primary gap-2 px-3 sm:px-4 py-2.5">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>
                    <span class="hidden sm:inline">Add Employee</span>
                </a>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(Model.Error))
        {
            <div class="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700 dark:border-red-900/40 dark:bg-red-900/20 dark:text-red-300">
                @Model.Error
            </div>
        }

        <div class="mb-6 rounded-2xl border border-slate-200 bg-white p-5 dark:border-slate-700 dark:bg-slate-800">
            <div class="flex flex-row flex-wrap items-center gap-3 lg:items-center">
                <div class="relative flex-1">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="h-5 w-5 text-gray-400 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </span>
                    <input type="text" id="searchInput"
                           class="h-10 w-full rounded-xl border border-gray-200 bg-white pl-10 text-sm focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500/20 dark:border-slate-600 dark:bg-slate-700 dark:text-white"
                           placeholder="Search employees...">
                </div>

                <div class="flex flex-wrap items-center gap-3">
                    <select id="filterStatus"
                            class="hidden sm:inline-block h-10 rounded-xl border border-gray-200 bg-white px-4 text-sm font-medium text-slate-600 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300">
                        <option value="">All work state</option>
                        <option value="Active">Active</option>
                        <option value="On Leave">On Leave</option>
                        <option value="Suspended">Suspended</option>
                        <option value="Probation">Probation</option>
                        <option value="Training">Training</option>
                    </select>

                    <select id="filterDepartment"
                            class="hidden sm:inline-block h-10 rounded-xl border border-gray-200 bg-white px-4 text-sm font-medium text-slate-600 dark:border-slate-600 dark:bg-slate-700 dark:text-slate-300">
                        <option value="">All Departments</option>
                    </select>

                    <button type="button" id="resetFilters" aria-label="Reset filters"
                            class="h-10 rounded-xl border border-gray-300 bg-white px-3 sm:px-5 text-xs font-medium uppercase tracking-wider text-slate-600 transition-all duration-150 hover:bg-slate-100 hover:border-slate-400 hover:text-slate-800 hover:scale-105 active:scale-95 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300 dark:hover:bg-slate-700 dark:hover:border-slate-400 inline-flex items-center gap-2">
                        <svg class="h-4 w-4 text-slate-500 dark:text-slate-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        <span class="hidden sm:inline">Reset</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Batch ID actions -->
        <div id="batchIdActions" class="mb-4 hidden rounded-xl border border-subgreen-200 bg-subgreen-50/50 px-4 py-3 dark:border-subgreen-800 dark:bg-subgreen-900/20">
            <div class="flex flex-wrap items-center gap-3">
                <span class="text-sm font-medium text-slate-700 dark:text-slate-300"><span id="batchSelectedCount">0</span> selected</span>
                <button type="button" id="batchPrintIds" class="btn-primary gap-2 px-4 py-2 text-sm">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5M9 21h3m-3 1v-4a2 2 0 012-2h2M7 17v4a2 2 0 002 2h10a2 2 0 002-2v-4M7 17h10" />
                    </svg>
                    Print IDs
                </button>
                <button type="button" id="batchDownloadPdf" class="btn-primary gap-2 px-4 py-2 text-sm">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Download IDs
                </button>
            </div>
        </div>

        <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-800">

            <!-- Stats -->
            <div class="grid grid-cols-2 divide-y divide-slate-100 border-b border-slate-100 lg:grid-cols-4 lg:divide-y-0 lg:divide-x dark:divide-slate-700 dark:border-slate-700">
                <div class="flex flex-col justify-center border-r border-slate-100 p-3 sm:p-4 last:border-r-0 dark:border-slate-700">
                    <p class="text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Total</p>
                    <p class="mt-0.5 text-right text-base sm:text-lg font-semibold text-slate-900 dark:text-white" id="statTotal">@Model.Employees.Count</p>
                </div>
                <div class="flex flex-col justify-center border-r border-slate-100 p-3 sm:p-4 last:border-r-0 dark:border-slate-700">
                    <p class="text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Active (WorkState)</p>
                    <p class="mt-0.5 text-right text-base sm:text-lg font-semibold text-subgreen-600 dark:text-subgreen-400" id="statActive">@Model.Employees.Count(e => e.WorkState == "Active")</p>
                </div>
                <div class="flex flex-col justify-center border-r border-slate-100 p-3 sm:p-4 last:border-r-0 dark:border-slate-700">
                    <p class="text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Other (On Leave, etc.)</p>
                    <p class="mt-0.5 text-right text-base sm:text-lg font-semibold text-amber-600 dark:text-amber-400" id="statInactive">@Model.Employees.Count(e => e.WorkState != "Active")</p>
                </div>
                <div class="flex flex-col justify-center border-r border-slate-100 p-3 sm:p-4 last:border-r-0 dark:border-slate-700">
                    <p class="text-xs font-medium uppercase tracking-wider text-slate-500 dark:text-slate-400">Archived</p>
                    <p class="mt-0.5 text-right text-base sm:text-lg font-semibold text-slate-600 dark:text-slate-400" id="statArchived">—</p>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="border-y border-slate-100 bg-slate-50/50 dark:border-slate-700 dark:bg-slate-800/50">
                            <th class="w-10 px-2 py-3 text-center">
                                <input type="checkbox" id="selectAllEmployees" aria-label="Select all"
                                       class="h-4 w-4 rounded border-slate-300 text-subgreen-600 focus:ring-subgreen-500" />
                            </th>
                            <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Team Member</th>
                            <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Role & Department</th>
                            <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Email</th>
                            <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Address</th>
                            <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Status</th>
                            <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Date Hired</th>
                            <th class="px-5 py-3 text-right text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Actions</th>
                        </tr>
                    </thead>

                    <tbody id="employeeTableBody" class="divide-y divide-slate-100 dark:divide-slate-700 text-sm">
                        @{
                            string Initials(string? fn, string? ln)
                            {
                                var first = string.IsNullOrWhiteSpace(fn) ? string.Empty : fn.Trim()[0].ToString().ToUpperInvariant();
                                var last = string.IsNullOrWhiteSpace(ln) ? string.Empty : ln.Trim()[0].ToString().ToUpperInvariant();
                                return string.Concat(first, last).Trim();
                            }
                            string FullName(string fn, string? mn, string ln) => string.Join(" ", new[] { fn, mn, ln }.Where(s => !string.IsNullOrWhiteSpace(s)));
                            string Addr(string? line, string? city, string? country) => string.Join(", ", new[] { line, city, country }.Where(s => !string.IsNullOrWhiteSpace(s)));
                        }

                        @foreach (var e in Model.Employees)
                        {
                            var name = FullName(e.FirstName, e.MiddleName, e.LastName);
                            var initial = string.IsNullOrWhiteSpace(name) ? "—" : Initials(e.FirstName, e.LastName);
                            var address = Addr(e.AddressLine1, e.City, e.Country);

                            var status = e.WorkState ?? "Active";
                            var isActive = string.Equals(status, "Active", StringComparison.OrdinalIgnoreCase);

                            var joined = e.DateHired?.ToString("MMM dd, yyyy") ?? "—";
                            var ageStr = e.Age.HasValue ? e.Age.Value.ToString() : "—";
                            var genderStr = string.IsNullOrWhiteSpace(e.Gender) ? "—" : e.Gender;

                            var hasId = !string.IsNullOrWhiteSpace(e.IdPictureUrl);
                            var issuedStatus = hasId ? "Active" : "Unissued";
                            var issuedStatusClass = hasId ? "text-subgreen-700 dark:text-subgreen-300 bg-subgreen-50 dark:bg-subgreen-900/30" : "text-amber-700 dark:text-amber-300 bg-amber-50 dark:bg-amber-900/20";
                            var avatarUrl = e.AvatarUrl ?? e.IdPictureUrl ?? "";
                            var email = e.Email ?? "";

                            <tr class="employee-row group transition-all hover:bg-subgreen-50/30 dark:hover:bg-subgreen-900/10"
                                data-emp-id="@e.EmpID"
                                data-emp-number="@e.EmpNumber"
                                data-status="@issuedStatus"
                                data-name="@name"
                                data-email="@(email)"
                                data-department="@(e.DepartmentName ?? "—")"
                                data-department-id="@(e.DepartmentID?.ToString() ?? "")"
                                data-role="@e.Role"
                                data-address="@address"
                                data-address-line1="@(e.AddressLine1 ?? "")"
                                data-joined="@joined"
                                data-date-hired="@(e.DateHired?.ToString("yyyy-MM-dd") ?? "")"
                                data-phone="@(e.Phone ?? "—")"
                                data-age="@ageStr"
                                data-gender="@genderStr"
                                data-avatar-url="@(avatarUrl)"
                                data-id-picture-url="@(e.IdPictureUrl ?? "")"
                                data-signature-url="@(e.SignatureUrl ?? "")"
                                data-ec-name="@(e.EmergencyContactName ?? "—")"
                                data-ec-phone="@(e.EmergencyContactPhone ?? "—")"
                                data-ec-relation="@(e.EmergencyContactRelation ?? "—")">

                                <td class="w-10 px-2 py-3 text-center">
                                    <input type="checkbox"
                                           class="employee-checkbox h-4 w-4 rounded border-slate-300 text-subgreen-600 focus:ring-subgreen-500"
                                           data-emp-id="@e.EmpID"
                                           aria-label="Select @name" />
                                </td>

                                <td class="px-5 py-3">
                                    <div class="flex items-center gap-3">
                                        @if (!string.IsNullOrWhiteSpace(avatarUrl))
                                        {
                                            <img src="@avatarUrl" alt="" class="h-9 w-9 rounded-full object-cover" />
                                        }
                                        else
                                        {
                                            <div class="flex h-9 w-9 items-center justify-center rounded-full bg-slate-200 text-xs font-medium text-slate-600 dark:bg-slate-700 dark:text-slate-400">@initial</div>
                                        }
                                        <div>
                                            <div class="text-sm font-medium text-slate-900 dark:text-white">@name</div>
                                            <div class="text-xs text-slate-500 dark:text-slate-400">@e.EmpNumber</div>
                                        </div>
                                    </div>
                                </td>

                                <td class="px-5 py-3">
                                    <div class="text-sm font-medium text-slate-900 dark:text-white">@e.Role</div>
                                    <div class="text-xs text-slate-500 dark:text-slate-400">@(e.DepartmentName ?? "—")</div>
                                </td>

                                <td class="px-5 py-3 text-sm text-slate-600 dark:text-slate-400">@(string.IsNullOrWhiteSpace(email) ? "—" : email)</td>

                                <td class="px-5 py-3 text-sm text-slate-600 dark:text-slate-400">@(string.IsNullOrWhiteSpace(address) ? "—" : address)</td>

                                <td class="px-5 py-3">
                                    <div class="relative inline-block" data-emp-id="@e.EmpID">
                                        <span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium @issuedStatusClass">@issuedStatus</span>
                                    </div>
                                </td>

                                <td class="px-5 py-3 text-sm text-slate-500 dark:text-slate-400">@joined</td>

                                <td class="px-5 py-3 text-right">
                                    <div class="flex justify-end gap-1 flex-wrap">
                                        <button type="button" onclick="openIdModal(@e.EmpID)"
                                                class="inline-flex items-center gap-1 rounded-lg bg-subgreen-100 px-2 py-1 text-xs font-medium text-subgreen-700 transition-all hover:bg-subgreen-200 dark:bg-subgreen-900/30 dark:text-subgreen-300 dark:hover:bg-subgreen-800/50"
                                                title="View / Print ID">
                                            ID
                                        </button>

                                        <button type="button" onclick="openViewModal(@e.EmpID)"
                                                class="inline-flex items-center gap-1 rounded-lg bg-sky-100 px-2 py-1 text-xs font-medium text-sky-700 transition-all hover:bg-sky-200 dark:bg-sky-900/30 dark:text-sky-300 dark:hover:bg-sky-800/50"
                                                title="View">
                                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                            </svg>
                                            View
                                        </button>

                                        <button type="button" onclick="openEditModal(@e.EmpID)"
                                                class="inline-flex items-center gap-1 rounded-lg bg-amber-100 px-2 py-1 text-xs font-medium text-amber-700 transition-all hover:bg-amber-200 dark:bg-amber-900/30 dark:text-amber-300 dark:hover:bg-amber-800/50"
                                                title="Edit">
                                            <svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.897L6 18l.8-2.685a4.5 4.5 0 011.897-1.897l8.932-8.931zm0 0L19.5 7.125" />
                                            </svg>
                                            Edit
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }

                        <tr id="employeeEmptyPlaceholder" class="empty-placeholder @(Model.Employees.Any() ? "hidden" : "")" aria-live="polite">
                            <td colspan="8" class="px-5 py-16 text-center">
                                <div class="flex flex-col items-center gap-3">
                                    <svg class="h-10 w-10 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                                    </svg>
                                    <p class="text-sm font-medium text-slate-500 dark:text-slate-400">No employees yet</p>
                                    <p class="text-xs text-slate-400 dark:text-slate-500">Add an employee to get started.</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination footer -->
            <div class="flex flex-col gap-4 border-t border-slate-100 bg-white px-5 py-4 dark:border-slate-700 dark:bg-slate-800 sm:flex-row sm:items-center sm:justify-between">

                <div class="flex flex-wrap items-center justify-between gap-4 sm:justify-start">
                    <div class="text-sm font-medium text-gray-500 dark:text-gray-400">
                        Showing <span class="font-semibold text-slate-900 dark:text-white" id="paginationShowing">0</span> of <span id="paginationTotal" class="font-semibold text-slate-900 dark:text-white">0</span>
                    </div>

                    <div class="flex items-center gap-2">
                        <span class="hidden text-xs font-medium uppercase text-slate-500 dark:text-slate-500 sm:inline">Rows</span>

                        <select id="rowsPerPage"
                                class="hidden h-9 rounded-lg border border-gray-200 bg-white px-2 text-sm font-medium text-slate-600 focus:border-blue-500 focus:outline-none dark:border-gray-700 dark:bg-gray-800 dark:text-gray-200 sm:inline-block">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                        </select>

                        <div class="relative inline-block sm:hidden">
                            <button id="rowsPerPageBtn" type="button"
                                    class="inline-flex h-9 w-9 items-center justify-center rounded-lg border border-gray-200 bg-white text-gray-600 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-800 dark:text-white"
                                    aria-haspopup="listbox" aria-expanded="false">
                                <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M3 12h18M3 18h18" />
                                </svg>
                            </button>

                            <div id="rowsPerPageMenu"
                                 class="absolute bottom-full left-0 mb-1 hidden min-w-[80px] rounded-xl border border-gray-200 bg-white py-1 shadow-xl dark:border-gray-700 dark:bg-gray-800 z-50">
                                <button type="button" class="rows-option w-full px-4 py-2 text-left text-sm font-medium text-slate-700 hover:bg-slate-50 dark:text-slate-200 dark:hover:bg-slate-700" data-value="5">5</button>
                                <button type="button" class="rows-option w-full px-4 py-2 text-left text-sm font-medium text-slate-700 hover:bg-slate-50 dark:text-slate-200 dark:hover:bg-slate-700" data-value="10">10</button>
                                <button type="button" class="rows-option w-full px-4 py-2 text-left text-sm font-medium text-slate-700 hover:bg-slate-50 dark:text-slate-200 dark:hover:bg-slate-700" data-value="20">20</button>
                                <button type="button" class="rows-option w-full px-4 py-2 text-left text-sm font-medium text-slate-700 hover:bg-slate-50 dark:text-slate-200 dark:hover:bg-slate-700" data-value="50">50</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center justify-center gap-0 sm:justify-end">
                    <nav class="isolate inline-flex -space-x-px rounded-lg shadow-sm" aria-label="Pagination">
                        <button type="button" id="paginationPrev"
                                class="inline-flex items-center rounded-l-lg border border-gray-200 bg-white px-2 py-2 text-gray-500 hover:bg-gray-50 focus:z-20 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:hover:bg-gray-700">
                            <span class="sr-only">Previous</span>
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>

                        <div id="paginationNumbers" class="inline-flex -space-x-px text-sm"></div>

                        <button type="button" id="paginationNext"
                                class="inline-flex items-center rounded-r-lg border border-gray-200 bg-white px-2 py-2 text-gray-500 hover:bg-gray-50 focus:z-20 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:hover:bg-gray-700">
                            <span class="sr-only">Next</span>
                            <svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </nav>
                </div>
            </div>

        </div> <!-- end table wrapper -->
    </div> <!-- end employeeContent -->
</div> <!-- end employeePageHost -->
<!-- Status dropdown portal -->
<div id="statusDropdownPortal" class="fixed z-[350] hidden min-w-[160px] rounded-xl border border-gray-200 bg-white py-1 shadow-xl dark:border-gray-700 dark:bg-gray-800">
    <button type="button" class="status-portal-action w-full px-4 py-2.5 text-left text-sm font-medium text-amber-700 hover:bg-amber-50 dark:text-amber-300 dark:hover:bg-amber-900/20" data-action="workstate">Work state</button>
    <button type="button" class="status-portal-action w-full px-4 py-2.5 text-left text-sm font-medium text-rose-600 hover:bg-rose-50 dark:hover:bg-rose-900/20" data-action="archive">Archive</button>
</div>

<!-- Unified Status Modal -->
<div id="statusActionModal" class="fixed inset-0 z-[200] hidden overflow-y-auto" role="dialog" aria-modal="true">
    <div class="flex min-h-screen items-center justify-center p-4">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeStatusActionModal()"></div>

        <div id="statusModalPanel" class="relative w-full max-w-md rounded-2xl border border-slate-200 bg-white shadow-2xl dark:border-slate-700 dark:bg-slate-900">

            <div id="statusModalWorkState" class="hidden">
                <div class="border-b border-amber-200 bg-amber-50/80 px-6 py-5 dark:border-amber-900/40 dark:bg-amber-900/20">
                    <h3 class="text-lg font-semibold text-amber-900 dark:text-amber-100">Work state</h3>
                    <p class="mt-1 text-sm text-amber-700 dark:text-amber-300">Choose the current work state for this employee.</p>
                </div>

                <form id="workStateForm" method="post" asp-page-handler="UpdateWorkState" data-turbo="false" class="p-6">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="workStateEmpId" value="" />

                    <label for="workStateSelect" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Reason <span class="text-red-500">*</span></label>
                    <select name="workState" id="workStateSelect" required class="w-full rounded-xl border border-slate-200 px-4 py-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-white">
                        <option value="Active">Active</option>
                        <option value="On Leave">On Leave</option>
                        <option value="Suspended">Suspended</option>
                        <option value="Probation">Probation</option>
                        <option value="Training">Training</option>
                    </select>

                    <div class="mt-6 flex flex-row-reverse gap-3">
                        <button type="submit" id="workStateSubmitBtn" class="rounded-xl bg-amber-600 px-5 py-2.5 text-sm font-semibold text-white hover:bg-amber-500 disabled:opacity-70 disabled:cursor-not-allowed">Update work state</button>
                        <button type="button" onclick="closeStatusActionModal()" class="rounded-xl border border-slate-300 px-5 py-2.5 text-sm font-medium text-slate-700 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">Cancel</button>
                    </div>
                </form>
            </div>

            <div id="statusModalArchive" class="hidden">
                <div class="border-b border-rose-200 bg-rose-50/80 px-6 py-5 dark:border-rose-900/40 dark:bg-rose-900/20">
                    <h3 class="text-lg font-semibold text-rose-900 dark:text-rose-100">Archive employee</h3>
                    <p class="mt-1 text-sm text-rose-700 dark:text-rose-300">Provide a reason (e.g. Resigned, Terminated). This will be stored and recorded in the audit log.</p>
                </div>

                <form id="archiveForm" method="post" asp-page-handler="Archive" data-turbo="false" class="p-6">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="archiveEmpId" value="" />

                    <label for="archiveReasonInput" class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Archive reason <span class="text-red-500">*</span></label>
                    <textarea name="reason" id="archiveReasonInput" required maxlength="200" rows="3"
                              class="w-full rounded-xl border border-slate-200 px-4 py-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-white"
                              placeholder="e.g. Resigned, Terminated, End of contract"></textarea>

                    <div class="mt-6 flex flex-row-reverse gap-3">
                        <button type="submit" id="archiveSubmitBtn" class="rounded-xl bg-rose-600 px-5 py-2.5 text-sm font-semibold text-white hover:bg-rose-500 disabled:opacity-70 disabled:cursor-not-allowed">Archive</button>
                        <button type="button" onclick="closeStatusActionModal()" class="rounded-xl border border-slate-300 px-5 py-2.5 text-sm font-medium text-slate-700 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">Cancel</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>

@{
    var idModalViewData = new ViewDataDictionary(ViewData)
    {
        ["OrgName"] = Model.OrgName,
        ["OrgLogoUrl"] = Model.OrgLogoUrl
    };
}
<!-- ✅ ID Modal moved to partial -->
<partial name="App/Employee/Partials/_EmployeeIdModal" view-data="idModalViewData" />

<!-- Edit Employee Modal -->
<div id="editModal" class="fixed inset-0 z-[200] hidden overflow-y-auto">
    <div class="flex min-h-screen items-center justify-center p-4">
        <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm" onclick="closeEditModal()"></div>

        <div class="relative w-full max-w-2xl transform overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-2xl transition-all dark:border-gray-700 dark:bg-gray-900">
            <div class="border-b border-gray-100 px-8 py-6 dark:border-gray-800">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Edit Employee</h3>
                <p class="mt-1 text-xs text-slate-500 dark:text-slate-400">Update employee details.</p>
            </div>

            <form id="editEmployeeForm" method="post" asp-page-handler="UpdateEmployee" data-turbo="false" class="p-8">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" id="editEmpID" value="" />

                <div class="grid grid-cols-1 gap-5 md:grid-cols-2">
                    <div class="md:col-span-2">
                        <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Full name</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div><input type="text" name="FirstName" id="editFirstName" class="h-11 w-full rounded-xl border border-gray-200 px-4 text-base focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white" placeholder="First name" required /></div>
                            <div><input type="text" name="MiddleName" id="editMiddleName" class="h-11 w-full rounded-xl border border-gray-200 px-4 text-base dark:border-gray-700 dark:bg-gray-800 dark:text-white" placeholder="Middle (optional)" /></div>
                            <div><input type="text" name="LastName" id="editLastName" class="h-11 w-full rounded-xl border border-gray-200 px-4 text-base focus:border-subgreen-500 focus:ring-2 focus:ring-subgreen-500/20 dark:border-gray-700 dark:bg-gray-800 dark:text-white" placeholder="Last name" required /></div>
                        </div>
                    </div>

                    <div>
                        <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Employee ID</label>
                        <input type="text" name="EmpNumber" id="editEmpNumber" class="h-11 w-full rounded-xl border border-gray-200 bg-slate-50 px-4 text-base dark:border-gray-700 dark:bg-gray-800 dark:text-slate-400" readonly />
                    </div>

                    <div>
                        <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Department</label>
                        <select name="DepartmentID" id="editDepartmentID" class="h-11 w-full rounded-xl border border-gray-200 px-4 text-base dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                            <option value="">— Select —</option>
                        </select>
                    </div>

                    <div>
                        <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Age</label>
                        <input type="number" name="age" id="editAge" class="h-11 w-full rounded-xl border border-gray-200 px-4 text-base dark:border-gray-700 dark:bg-gray-800 dark:text-white" min="1" max="120" />
                    </div>

                    <div>
                        <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Gender</label>
                        <select name="gender" id="editGender" class="h-11 w-full rounded-xl border border-gray-200 px-4 text-base dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                            <option value="">— Select —</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                            <option value="Non-binary">Non-binary</option>
                            <option value="Prefer not to say">Prefer not to say</option>
                        </select>
                    </div>

                    <div>
                        <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Role</label>
                        <select name="role" id="editRole" class="h-11 w-full rounded-xl border border-gray-200 px-4 text-base dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                            <option value="Employee">Employee</option>
                            <option value="HR">HR</option>
                            <option value="Manager">Manager</option>
                            <option value="PayrollPersonnel">Payroll Personnel</option>
                        </select>
                    </div>

                    <div>
                        <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Employment type</label>
                        <select name="EmploymentType" id="editEmploymentType" class="h-11 w-full rounded-xl border border-gray-200 px-4 text-base dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                            <option value="Regular">Regular</option>
                            <option value="Contractual">Contractual</option>
                            <option value="Part-Time">Part-Time</option>
                        </select>
                    </div>

                    <div>
                        <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Work state</label>
                        <select name="workState" id="editWorkState" class="h-11 w-full rounded-xl border border-gray-200 px-4 text-base dark:border-gray-700 dark:bg-gray-800 dark:text-white">
                            <option value="Active">Active</option>
                            <option value="On Leave">On Leave</option>
                            <option value="Suspended">Suspended</option>
                            <option value="Probation">Probation</option>
                            <option value="Training">Training</option>
                        </select>
                    </div>

                    <div>
                        <label class="mb-1.5 block text-sm font-medium text-slate-700 dark:text-slate-300">Date hired</label>
                        <input type="date" name="dateHired" id="editDateHired" class="h-11 w-full rounded-xl border border-slate-200 px-4 text-base dark:border-slate-600 dark:bg-slate-800 dark:text-white" />
                    </div>

                    <!-- Address + contact sections unchanged (kept as-is) -->
                    <div class="md:col-span-2">
                        <h4 class="mb-2 text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Address</h4>
                        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                            <div class="address-autocomplete relative sm:col-span-2">
                                <input type="text" name="AddressLine1" id="editAddressLine1" class="h-10 w-full rounded-xl border border-slate-200 px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-white" placeholder="Start typing address..." autocomplete="off" />
                                <div id="editAddressSuggestions" class="absolute left-0 right-0 top-full z-20 mt-1 hidden max-h-60 overflow-auto rounded-xl border border-slate-200 bg-white shadow-lg dark:border-slate-600 dark:bg-slate-800"></div>
                            </div>
                            <div class="sm:col-span-2"><input type="text" name="AddressLine2" id="editAddressLine2" class="h-10 w-full rounded-xl border border-slate-200 px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-white" placeholder="Address line 2 (optional)" /></div>
                            <div><input type="text" name="City" id="editCity" class="h-10 w-full rounded-xl border border-slate-200 px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-white" placeholder="City" /></div>
                            <div><input type="text" name="StateProvince" id="editStateProvince" class="h-10 w-full rounded-xl border border-slate-200 px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-white" placeholder="State / Province" /></div>
                            <div><input type="text" name="PostalCode" id="editPostalCode" class="h-10 w-full rounded-xl border border-slate-200 px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-white" placeholder="Postal code" /></div>
                            <div><input type="text" name="Country" id="editCountry" class="h-10 w-full rounded-xl border border-slate-200 px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-white" placeholder="Country" /></div>
                        </div>
                    </div>

                    <div class="md:col-span-2">
                        <h4 class="mb-2 text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Account / contact</h4>
                        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                            <div>
                                <label class="mb-1 block text-xs text-slate-500">Phone</label>
                                <div class="flex rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-800">
                                    <span class="inline-flex items-center rounded-l-xl border-r border-slate-200 bg-slate-50 px-3 text-sm text-slate-600 dark:border-slate-600 dark:bg-slate-800/50 dark:text-slate-400">+63</span>
                                    <input type="tel" name="Phone" id="editPhone" class="ph-phone-input h-10 min-w-0 flex-1 rounded-r-xl border-0 bg-transparent px-3 text-sm dark:text-white" placeholder="0956 777 9876" maxlength="14" />
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="md:col-span-2">
                        <h4 class="mb-2 text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Emergency contact</h4>
                        <div class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                            <div><label class="mb-1 block text-xs text-slate-500">Name</label><input type="text" name="EmergencyContactName" id="editEmergencyContactName" class="h-10 w-full rounded-xl border border-slate-200 px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-white" placeholder="Full name" /></div>
                            <div><label class="mb-1 block text-xs text-slate-500">Phone</label><div class="flex rounded-xl border border-slate-200 dark:border-slate-600 dark:bg-slate-800"><span class="inline-flex items-center rounded-l-xl border-r border-slate-200 bg-slate-50 px-3 text-sm text-slate-600 dark:border-slate-600 dark:bg-slate-800/50 dark:text-slate-400">+63</span><input type="tel" name="EmergencyContactPhone" id="editEmergencyContactPhone" class="ph-phone-input h-10 min-w-0 flex-1 rounded-r-xl border-0 bg-transparent px-3 text-sm dark:text-white" placeholder="0956 777 9876" maxlength="14" /></div></div>
                            <div><label class="mb-1 block text-xs text-slate-500">Relation</label><input type="text" name="EmergencyContactRelation" id="editEmergencyContactRelation" class="h-10 w-full rounded-xl border border-slate-200 px-3 text-sm dark:border-slate-600 dark:bg-slate-800 dark:text-white" placeholder="e.g. Spouse, Parent" /></div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex gap-3">
                    <button type="button" onclick="closeEditModal()" class="btn-secondary h-12 flex-1">Cancel</button>
                    <button type="submit" id="editEmployeeSubmitBtn" class="btn-primary h-12 flex-1 disabled:opacity-70 disabled:cursor-not-allowed">Update Employee</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- View Employee Modal (unchanged from your version) -->
<div id="viewModal" class="fixed inset-0 z-[200] hidden overflow-y-auto">
    <div class="flex min-h-screen items-center justify-center p-4">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeViewModal()"></div>
        <div class="relative max-h-[90vh] w-full max-w-2xl overflow-y-auto rounded-2xl border border-slate-200 bg-white shadow-2xl dark:border-slate-700 dark:bg-slate-900">
            <div class="sticky top-0 z-10 border-b border-slate-100 bg-white px-6 py-4 dark:border-slate-800 dark:bg-slate-900">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Employee information</h3>
                <p class="mt-1 text-sm text-slate-500 dark:text-slate-400">View only. Use Edit to change details.</p>
            </div>
            <div class="p-6 space-y-6">
                <!-- your view content kept intact -->
                <section>
                    <h4 class="mb-3 text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Personal info</h4>
                    <dl class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                        <div><dt class="text-xs text-slate-500">Full name</dt><dd id="viewName" class="text-sm font-medium text-slate-900 dark:text-white">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Employee ID</dt><dd id="viewEmpNumber" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Email</dt><dd id="viewEmail" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Age</dt><dd id="viewAge" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Gender</dt><dd id="viewGender" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Role</dt><dd id="viewRole" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Department</dt><dd id="viewDepartment" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Status</dt><dd id="viewStatus" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Employment type</dt><dd id="viewEmploymentType" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Date Hired</dt><dd id="viewJoined" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                    </dl>
                </section>

                <section>
                    <h4 class="mb-3 text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Address</h4>
                    <dl class="grid grid-cols-1 gap-2 sm:grid-cols-2">
                        <div class="sm:col-span-2"><dt class="text-xs text-slate-500">Address line 1</dt><dd id="viewAddressLine1" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div class="sm:col-span-2"><dt class="text-xs text-slate-500">Address line 2</dt><dd id="viewAddressLine2" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">City</dt><dd id="viewCity" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">State / Province</dt><dd id="viewStateProvince" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Postal code</dt><dd id="viewPostalCode" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Country</dt><dd id="viewCountry" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                    </dl>
                </section>

                <section>
                    <h4 class="mb-3 text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Account / contact</h4>
                    <dl class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                        <div><dt class="text-xs text-slate-500">Phone</dt><dd id="viewPhone" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                    </dl>
                </section>

                <section>
                    <h4 class="mb-3 text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Emergency contact</h4>
                    <dl class="grid grid-cols-1 gap-3 sm:grid-cols-2">
                        <div><dt class="text-xs text-slate-500">Name</dt><dd id="viewEcName" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Phone</dt><dd id="viewEcPhone" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                        <div><dt class="text-xs text-slate-500">Relation</dt><dd id="viewEcRelation" class="text-sm text-slate-700 dark:text-slate-300">—</dd></div>
                    </dl>
                </section>
            </div>

            <div class="border-t border-slate-100 bg-slate-50/50 px-6 py-4 dark:border-slate-800 dark:bg-slate-800/50">
                <button type="button" onclick="closeViewModal()" class="rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        var host = document.getElementById('employeePageHost');
        var skeleton = document.getElementById('employeeSkeleton');
        var content = document.getElementById('employeeContent');
        var tbody = document.getElementById('employeeTableBody');
        var placeholder = document.getElementById('employeeEmptyPlaceholder');
        if (!host || !skeleton || !content || !tbody) return;

        var shownAt = Date.now();
        var revealTimer = null;
        var minVisibleMs = window.matchMedia('(prefers-reduced-motion: reduce)').matches ? 0 : 220;

        function showSkeleton() {
            if (revealTimer) { clearTimeout(revealTimer); revealTimer = null; }
            shownAt = Date.now();
            host.setAttribute('aria-busy', 'true');
            skeleton.classList.remove('hidden');
            content.classList.add('hidden');
        }

        function revealEmployeeContent() {
            var elapsed = Date.now() - shownAt;
            var wait = Math.max(0, minVisibleMs - elapsed);
            revealTimer = setTimeout(function () {
                skeleton.classList.add('hidden');
                content.classList.remove('hidden');
                host.setAttribute('aria-busy', 'false');
                revealTimer = null;
            }, wait);
        }

        function esc(s) {
            if (s == null || s === undefined) return '';
            return String(s)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;');
        }

        function initials(fn, ln) {
            var f = (fn && fn.trim()) ? fn.trim().charAt(0).toUpperCase() : ' ';
            var l = (ln && ln.trim()) ? ln.trim().charAt(0).toUpperCase() : ' ';
            return (f + l).trim() || '—';
        }

        function fullName(fn, mn, ln) {
            return [fn, mn, ln].filter(Boolean).join(' ').trim() || '—';
        }

        function addr(line, city, country) {
            return [line, city, country].filter(Boolean).join(', ').trim() || '—';
        }

        function buildRow(e) {
            var name = fullName(e.firstName || e.FirstName, e.middleName || e.MiddleName, e.lastName || e.LastName);
            var initial = name === '—' ? '—' : initials(e.firstName || e.FirstName, e.lastName || e.LastName);

            var address = addr(e.addressLine1 || e.AddressLine1, e.city || e.City, e.country || e.Country);
            var status = (e.workState || e.WorkState || 'Active').trim() || 'Active';
            var isActive = status.toLowerCase() === 'active';

            var joined = e.dateHired || e.DateHired;
            var joinedStr = '—';
            if (joined) {
                var d = new Date(joined);
                if (!isNaN(d.getTime())) {
                    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    joinedStr = months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
                }
            }

            var empId = e.empID != null ? e.empID : e.EmpID;
            var empNumber = e.empNumber || e.EmpNumber || '';
            var role = e.role || e.Role || '';
            var deptName = e.departmentName || e.DepartmentName || '—';
            var deptId = (e.departmentID != null ? e.departmentID : e.DepartmentID);

            var ageStr = (e.age != null ? e.age : e.Age) != null ? String(e.age != null ? e.age : e.Age) : '—';
            var genderStr = (e.gender || e.Gender) || '—';

            var avatarUrl = e.avatarUrl || e.AvatarUrl || e.idPictureUrl || e.IdPictureUrl || '';
            var idPictureUrl = e.idPictureUrl || e.IdPictureUrl || '';
            var signatureUrl = e.signatureUrl || e.SignatureUrl || '';
            var addressLine1 = e.addressLine1 || e.AddressLine1 || '';

            var hasId = !!idPictureUrl;
            var issuedStatus = hasId ? 'Active' : 'Unissued';
            var issuedStatusClass = hasId
                ? 'text-subgreen-700 dark:text-subgreen-300 bg-subgreen-50 dark:bg-subgreen-900/30'
                : 'text-amber-700 dark:text-amber-300 bg-amber-50 dark:bg-amber-900/20';

            var email = (e.email || e.Email || '').trim();

            var photoCell = avatarUrl
                ? '<img src="' + esc(avatarUrl) + '" alt="" class="h-9 w-9 rounded-full object-cover" />'
                : '<div class="flex h-9 w-9 items-center justify-center rounded-full bg-slate-200 text-xs font-medium text-slate-600 dark:bg-slate-700 dark:text-slate-400">' + esc(initial) + '</div>';

            var tr = document.createElement('tr');
            tr.className = 'employee-row group transition-all hover:bg-subgreen-50/30 dark:hover:bg-subgreen-900/10';

            tr.setAttribute('data-emp-id', empId);
            tr.setAttribute('data-emp-number', empNumber);
            tr.setAttribute('data-status', issuedStatus);
            tr.setAttribute('data-name', name);
            tr.setAttribute('data-email', email);
            tr.setAttribute('data-department', deptName);
            tr.setAttribute('data-department-id', deptId != null ? String(deptId) : '');
            tr.setAttribute('data-role', role);
            tr.setAttribute('data-address', address);
            tr.setAttribute('data-address-line1', addressLine1);
            tr.setAttribute('data-avatar-url', avatarUrl);
            tr.setAttribute('data-id-picture-url', idPictureUrl);
            tr.setAttribute('data-signature-url', signatureUrl);
            tr.setAttribute('data-joined', joinedStr);
            tr.setAttribute('data-date-hired', (joined && typeof joined === 'string') ? joined.substring(0, 10) : '');
            tr.setAttribute('data-phone', (e.phone || e.Phone) || '—');
            tr.setAttribute('data-age', ageStr);
            tr.setAttribute('data-gender', genderStr);
            tr.setAttribute('data-ec-name', (e.emergencyContactName != null ? e.emergencyContactName : e.EmergencyContactName) || '—');
            tr.setAttribute('data-ec-phone', (e.emergencyContactPhone != null ? e.emergencyContactPhone : e.EmergencyContactPhone) || '—');
            tr.setAttribute('data-ec-relation', (e.emergencyContactRelation != null ? e.emergencyContactRelation : e.EmergencyContactRelation) || '—');

            tr.innerHTML =
                '<td class="w-10 px-2 py-3 text-center">' +
                '<input type="checkbox" class="employee-checkbox h-4 w-4 rounded border-slate-300 text-subgreen-600 focus:ring-subgreen-500" data-emp-id="' + empId + '" aria-label="Select ' + esc(name) + '" />' +
                '</td>' +
                '<td class="px-5 py-3"><div class="flex items-center gap-3">' + photoCell +
                '<div><div class="text-sm font-medium text-slate-900 dark:text-white">' + esc(name) + '</div>' +
                '<div class="text-xs text-slate-500 dark:text-slate-400">' + esc(empNumber) + '</div></div></div></td>' +
                '<td class="px-5 py-3"><div class="text-sm font-medium text-slate-900 dark:text-white">' + esc(role) + '</div>' +
                '<div class="text-xs text-slate-500 dark:text-slate-400">' + esc(deptName) + '</div></td>' +
                '<td class="px-5 py-3 text-sm text-slate-600 dark:text-slate-400">' + (email ? esc(email) : '—') + '</td>' +
                '<td class="px-5 py-3 text-sm text-slate-600 dark:text-slate-400">' + (address ? esc(address) : '—') + '</td>' +
                '<td class="px-5 py-3"><span class="inline-flex items-center rounded-md px-2 py-0.5 text-xs font-medium ' + issuedStatusClass + '">' + esc(issuedStatus) + '</span></td>' +
                '<td class="px-5 py-3 text-sm text-slate-500 dark:text-slate-400">' + esc(joinedStr) + '</td>' +
                '<td class="px-5 py-3 text-right"><div class="flex justify-end gap-1 flex-wrap">' +
                '<button type="button" onclick="openIdModal(' + empId + ')" class="inline-flex items-center gap-1 rounded-lg bg-subgreen-100 px-2 py-1 text-xs font-medium text-subgreen-700 transition-all hover:bg-subgreen-200 dark:bg-subgreen-900/30 dark:text-subgreen-300 dark:hover:bg-subgreen-800/50" title="View / Print ID">ID</button>' +
                '<button type="button" onclick="openViewModal(' + empId + ')" class="inline-flex items-center gap-1 rounded-lg bg-sky-100 px-2 py-1 text-xs font-medium text-sky-700 transition-all hover:bg-sky-200 dark:bg-sky-900/30 dark:text-sky-300 dark:hover:bg-sky-800/50" title="View"><svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>View</button>' +
                '<button type="button" onclick="openEditModal(' + empId + ')" class="inline-flex items-center gap-1 rounded-lg bg-amber-100 px-2 py-1 text-xs font-medium text-amber-700 transition-all hover:bg-amber-200 dark:bg-amber-900/30 dark:text-amber-300 dark:hover:bg-amber-800/50" title="Edit"><svg class="h-3.5 w-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.897L6 18l.8-2.685a4.5 4.5 0 011.897-1.897l8.932-8.931zm0 0L19.5 7.125" /></svg>Edit</button>' +
                '</div></td>';

            return tr;
        }

        showSkeleton();

        function onDataReady() {
            var filterDept = document.getElementById('filterDepartment');
            var editDept = document.getElementById('editDepartmentID');

            var fallbackTimer = setTimeout(function () {
                skeleton.classList.add('hidden');
                content.classList.remove('hidden');
                host.setAttribute('aria-busy', 'false');
                if (placeholder) {
                    var emptyTd = placeholder.querySelector('td');
                    if (emptyTd) emptyTd.innerHTML = '<p class="text-sm text-slate-600 dark:text-slate-400">Loading timed out. Please refresh the page.</p>';
                    placeholder.classList.remove('hidden');
                }
            }, 6000);

            fetch(window.location.pathname + '?handler=Data', { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
                .then(function (r) { if (!r.ok) throw new Error('Request failed: ' + r.status); return r.json(); })
                .then(function (data) {
                    clearTimeout(fallbackTimer);

                    var employees = (data && data.employees) ? data.employees : [];
                    var departments = (data && data.departments) ? data.departments : [];

                    if (filterDept) {
                        filterDept.innerHTML = '<option value="">All Departments</option>';
                        departments.forEach(function (d) {
                            var opt = document.createElement('option');
                            opt.value = String(d.depID != null ? d.depID : d.DepID);
                            opt.textContent = d.departmentName || d.DepartmentName || '';
                            filterDept.appendChild(opt);
                        });
                    }

                    if (editDept) {
                        editDept.innerHTML = '<option value="">— Select —</option>';
                        departments.forEach(function (d) {
                            var opt = document.createElement('option');
                            opt.value = String(d.depID != null ? d.depID : d.DepID);
                            opt.textContent = d.departmentName || d.DepartmentName || '';
                            editDept.appendChild(opt);
                        });
                    }

                    tbody.querySelectorAll('.employee-row').forEach(function (r) { r.remove(); });

                    employees.forEach(function (e) {
                        try { tbody.insertBefore(buildRow(e), placeholder); } catch (err) { }
                    });

                    if (placeholder) placeholder.classList.toggle('hidden', employees.length > 0);

                    var statTotal = document.getElementById('statTotal');
                    var statActive = document.getElementById('statActive');
                    var statInactive = document.getElementById('statInactive');

                    if (statTotal) statTotal.textContent = employees.length;

                    var activeCount = employees.filter(function (e) {
                        return ((e.workState || e.WorkState) || '').toLowerCase() === 'active';
                    }).length;

                    if (statActive) statActive.textContent = activeCount;
                    if (statInactive) statInactive.textContent = employees.length - activeCount;

                    revealEmployeeContent();
                    if (typeof filterRows === 'function') filterRows();
                })
                .catch(function () {
                    clearTimeout(fallbackTimer);
                    skeleton.classList.add('hidden');
                    content.classList.remove('hidden');
                    host.setAttribute('aria-busy', 'false');
                    if (placeholder) {
                        placeholder.classList.remove('hidden');
                        var emptyTd = placeholder.querySelector('td');
                        if (emptyTd) emptyTd.innerHTML = 'Unable to load employees. Please refresh the page.';
                    }
                });
        }

        if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', onDataReady, { once: true });
        else onDataReady();

        function getRows() { return document.querySelectorAll('.employee-row'); }
        function getSelectedEmpIds() {
            var checkboxes = document.querySelectorAll('.employee-checkbox:checked');
            return Array.from(checkboxes).map(function (cb) { return parseInt(cb.getAttribute('data-emp-id'), 10); }).filter(Boolean);
        }
        function updateBatchActions() {
            var ids = getSelectedEmpIds();
            var bar = document.getElementById('batchIdActions');
            var countEl = document.getElementById('batchSelectedCount');
            if (!bar || !countEl) return;
            if (ids.length > 0) { bar.classList.remove('hidden'); countEl.textContent = ids.length; }
            else bar.classList.add('hidden');
        }

        const searchInput = document.getElementById('searchInput');
        const filterStatus = document.getElementById('filterStatus');
        const filterDepartment = document.getElementById('filterDepartment');
        const resetFilters = document.getElementById('resetFilters');
        const rowsPerPage = document.getElementById('rowsPerPage');
        let currentPage = 1;

        function getVisibleRows() {
            var rows = getRows();
            const search = (searchInput?.value || '').toLowerCase();
            const status = (filterStatus?.value || '').toLowerCase();
            const deptVal = (filterDepartment?.value || '');
            const deptText = (deptVal || '').toLowerCase();

            return Array.from(rows).filter(function (tr) {
                const name = (tr.getAttribute('data-name') || '').toLowerCase();
                const email = (tr.getAttribute('data-email') || '').toLowerCase();
                const rowStatus = (tr.getAttribute('data-status') || '').toLowerCase();
                const departmentName = (tr.getAttribute('data-department') || '').toLowerCase();
                const deptId = (tr.getAttribute('data-department-id') || '');

                const matchSearch = !search || name.includes(search) || email.includes(search);
                const matchStatus = !status || rowStatus === status;
                const matchDept = !deptVal || deptId === deptVal || departmentName.includes(deptText);

                return matchSearch && matchStatus && matchDept;
            });
        }

        function filterRows() {
            const visible = getVisibleRows();
            const perPage = parseInt(rowsPerPage?.value || '10', 10) || 10;
            const totalPages = Math.max(1, Math.ceil(visible.length / perPage));

            currentPage = Math.min(currentPage, totalPages) || 1;

            const start = (currentPage - 1) * perPage;
            const end = start + perPage;

            getRows().forEach(function (tr) { tr.style.display = 'none'; });
            visible.slice(start, end).forEach(function (tr) { tr.style.display = ''; });

            var emptyRow = document.getElementById('employeeEmptyPlaceholder');
            if (emptyRow) {
                var hasFilter = (searchInput && searchInput.value.trim()) || (filterStatus && filterStatus.value) || (filterDepartment && filterDepartment.value);
                if (visible.length === 0) {
                    emptyRow.classList.remove('hidden');
                    var emptyTd = emptyRow.querySelector('td');
                    if (emptyTd) {
                        emptyTd.innerHTML = hasFilter
                            ? '<div class="flex flex-col items-center gap-3"><svg class="h-10 w-10 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L13 13.414V19a1 1 0 01-.553.894l-4 2A1 1 0 017 21v-7.586L3.293 6.707A1 1 0 013 6V4z" /></svg><p class="text-sm font-medium text-slate-500 dark:text-slate-400">No results match your filters</p><p class="text-xs text-slate-400 dark:text-slate-500">Try adjusting your search or filters.</p></div>'
                            : '<div class="flex flex-col items-center gap-3"><svg class="h-10 w-10 text-slate-300 dark:text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg><p class="text-sm font-medium text-slate-500 dark:text-slate-400">No employees yet</p><p class="text-xs text-slate-400 dark:text-slate-500">Add an employee to get started.</p></div>';
                    }
                } else emptyRow.classList.add('hidden');
            }

            var showing = visible.length === 0 ? 0 : visible.slice(start, end).length;
            var showingEl = document.getElementById('paginationShowing');
            var totalEl = document.getElementById('paginationTotal');
            if (showingEl) showingEl.textContent = showing;
            if (totalEl) totalEl.textContent = visible.length;

            var container = document.getElementById('paginationNumbers');
            if (container) {
                container.innerHTML = '';
                for (var i = 1; i <= totalPages; i++) {
                    var btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = (i === currentPage)
                        ? 'h-9 min-w-[40px] rounded-md border px-3 text-sm font-semibold border-subgreen-200 bg-subgreen-50 text-subgreen-700 dark:border-subgreen-900/40 dark:bg-subgreen-900/20 dark:text-subgreen-300'
                        : 'h-9 min-w-[40px] rounded-md border px-3 text-sm font-semibold border-gray-200 bg-white text-gray-600 hover:bg-gray-50 dark:border-gray-700 dark:bg-gray-900 dark:text-gray-200 dark:hover:bg-gray-800';
                    btn.textContent = i;
                    (function (p) { btn.addEventListener('click', function () { currentPage = p; filterRows(); }); })(i);
                    container.appendChild(btn);
                }
            }

            var prevBtn = document.getElementById('paginationPrev');
            var nextBtn = document.getElementById('paginationNext');
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;
        }

        document.getElementById('selectAllEmployees')?.addEventListener('change', function () {
            var visible = getVisibleRows();
            visible.forEach(function (tr) {
                var cb = tr.querySelector('.employee-checkbox');
                if (cb) cb.checked = this.checked;
            }.bind(this));
            updateBatchActions();
        });

        tbody.addEventListener('change', function (e) {
            if (e.target && e.target.classList.contains('employee-checkbox')) updateBatchActions();
        });

        window.getSelectedEmpIds = getSelectedEmpIds;

        rowsPerPage?.addEventListener('change', function () { currentPage = 1; filterRows(); });
        document.getElementById('paginationPrev')?.addEventListener('click', function () { if (currentPage > 1) { currentPage--; filterRows(); } });
        document.getElementById('paginationNext')?.addEventListener('click', function () { currentPage++; filterRows(); });
        searchInput?.addEventListener('input', function () { currentPage = 1; filterRows(); });
        filterStatus?.addEventListener('change', function () { currentPage = 1; filterRows(); });
        filterDepartment?.addEventListener('change', function () { currentPage = 1; filterRows(); });
        resetFilters?.addEventListener('click', function () {
            if (searchInput) searchInput.value = '';
            if (filterStatus) filterStatus.value = '';
            if (filterDepartment) filterDepartment.value = '';
            currentPage = 1;
            filterRows();
        });

        var rowsPerPageBtn = document.getElementById('rowsPerPageBtn');
        var rowsPerPageMenu = document.getElementById('rowsPerPageMenu');

        if (rowsPerPageBtn && rowsPerPageMenu) {
            rowsPerPageBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                var isOpen = !rowsPerPageMenu.classList.contains('hidden');
                rowsPerPageMenu.classList.toggle('hidden', isOpen);
                rowsPerPageBtn.setAttribute('aria-expanded', String(!isOpen));
            });

            rowsPerPageMenu.addEventListener('click', function (e) {
                var btn = e.target.closest('button.rows-option');
                if (!btn) return;
                e.stopPropagation();
                var val = btn.getAttribute('data-value');
                if (rowsPerPage && val) {
                    rowsPerPage.value = val;
                    rowsPerPage.dispatchEvent(new Event('change'));
                }
                rowsPerPageMenu.classList.add('hidden');
                rowsPerPageBtn.setAttribute('aria-expanded', 'false');
            });

            document.addEventListener('click', function () {
                rowsPerPageMenu.classList.add('hidden');
                rowsPerPageBtn.setAttribute('aria-expanded', 'false');
            });
        }

        filterRows();
    })();
</script>

<script>
    var statusPortalRow = null;

    function toggleStatusMenu(btn) {
        var portal = document.getElementById('statusDropdownPortal');
        if (!portal) return;

        var wrap = btn.closest('[data-emp-id]');
        var row = wrap ? wrap.closest('tr') : null;
        var id = wrap ? wrap.getAttribute('data-emp-id') : null;
        var empId = id ? parseInt(id, 10) : 0;
        if (!empId) return;

        statusPortalRow = row;

        var rect = btn.getBoundingClientRect();
        portal.style.left = rect.left + 'px';
        portal.style.top = (rect.bottom + 4) + 'px';
        portal.dataset.empId = String(empId);
        portal.classList.remove('hidden');
    }

    function closeStatusPortal() {
        var portal = document.getElementById('statusDropdownPortal');
        if (portal) portal.classList.add('hidden');
        statusPortalRow = null;
    }

    document.getElementById('statusDropdownPortal')?.addEventListener('click', function (e) {
        var b = e.target.closest('.status-portal-action');
        if (!b) return;
        e.stopPropagation();

        var action = b.getAttribute('data-action');
        var empId = parseInt(this.dataset.empId || '0', 10);
        var row = statusPortalRow;

        closeStatusPortal();

        if (action === 'workstate' && empId) openStatusActionModal('workstate', empId, row);
        else if (action === 'archive' && empId) openStatusActionModal('archive', empId, row);
    });

    document.addEventListener('click', function (e) {
        if (e.target.closest('#statusDropdownPortal') || e.target.closest('.status-badge')) return;
        closeStatusPortal();
    });

    function openStatusActionModal(mode, empId, row) {
        var modal = document.getElementById('statusActionModal');
        var workStatePanel = document.getElementById('statusModalWorkState');
        var archivePanel = document.getElementById('statusModalArchive');

        if (mode === 'workstate') {
            document.getElementById('workStateEmpId').value = empId;
            var currentStatus = row ? (row.getAttribute('data-status') || 'Active') : 'Active';
            var sel = document.getElementById('workStateSelect');
            if (sel) sel.value = currentStatus;

            workStatePanel.classList.remove('hidden');
            archivePanel.classList.add('hidden');
        } else {
            document.getElementById('archiveEmpId').value = empId;
            document.getElementById('archiveReasonInput').value = '';

            workStatePanel.classList.add('hidden');
            archivePanel.classList.remove('hidden');
        }

        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function closeStatusActionModal() {
        document.getElementById('statusActionModal')?.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
</script>

<script>
    var idCardFlipped = false;

    function getIdEl(id) {
        return document.getElementById(id);
    }

    function setIdText(id, text) {
        var el = getIdEl(id);
        if (el) el.textContent = text;
    }

    function formatPhoneForId(phone) {
        if (!phone || phone === '—') return '—';
        return phone.indexOf('+') === 0 ? phone : '+63 ' + phone;
    }

    function extractRowCardData(row) {
        if (!row) return null;
        return {
            empId: row.getAttribute('data-emp-id') || '',
            name: row.getAttribute('data-name') || '—',
            empNumber: row.getAttribute('data-emp-number') || '—',
            role: row.getAttribute('data-role') || '—',
            email: row.getAttribute('data-email') || '—',
            phone: formatPhoneForId(row.getAttribute('data-phone') || '—'),
            address: row.getAttribute('data-address') || '—',
            idPictureUrl: row.getAttribute('data-id-picture-url') || '',
            avatarUrl: row.getAttribute('data-avatar-url') || '',
            signatureUrl: row.getAttribute('data-signature-url') || '',
            ecName: row.getAttribute('data-ec-name') || '—',
            ecPhone: row.getAttribute('data-ec-phone') || '—',
            ecRelation: row.getAttribute('data-ec-relation') || '—',
            hasPhoto: !!(row.getAttribute('data-id-picture-url'))
        };
    }

    function applyIdCardData(data) {
        if (!data) return;
        setIdText('idCardModalTitle', (data.name || 'Employee ID') + ' – ID');
        setIdText('idCardName', data.name || '—');
        setIdText('idCardRole', data.role || '—');
        setIdText('idCardEmpNumber', data.empNumber ? 'Employee No: ' + data.empNumber : 'Employee No: —');
        setIdText('idCardEmail', data.email && data.email !== '—' ? data.email : '—');
        setIdText('idCardPhone', data.phone || '—');
        setIdText('idCardAddress', data.address || '—');
        setIdText('idCardEcName', data.ecName || '—');
        setIdText('idCardEcPhone', data.ecPhone || '—');
        setIdText('idCardEcRelation', data.ecRelation || '—');

        var qrEl = getIdEl('idCardQr');
        if (qrEl && data.empId) qrEl.src = window.location.pathname + '?handler=AttendanceQr&id=' + encodeURIComponent(data.empId);

        var sigEl = getIdEl('idCardSignature');
        if (sigEl) {
            if (data.signatureUrl) {
                sigEl.src = data.signatureUrl;
                sigEl.style.display = '';
                sigEl.onerror = function () { this.style.display = 'none'; };
            } else {
                sigEl.src = '';
                sigEl.style.display = 'none';
            }
        }

        var photoEl = getIdEl('idCardPhoto');
        var photoSrc = data.idPictureUrl || data.avatarUrl;
        if (photoEl) {
            if (photoSrc) {
                photoEl.src = photoSrc;
                photoEl.style.display = '';
                photoEl.onerror = function () { this.style.display = 'none'; };
            } else {
                photoEl.src = '';
                photoEl.style.display = 'none';
            }
        }

        var printBtn = getIdEl('idCardPrintBtn');
        if (printBtn && data.empId) printBtn.setAttribute('data-emp-id', String(data.empId));
    }

    function toggleIdCardAvailability(hasPhoto) {
        var noIdMsg = getIdEl('idCardNoIdMessage');
        var cardContainer = getIdEl('idCardFlipContainer');
        var printBtn = getIdEl('idCardPrintBtn');
        if (hasPhoto) {
            noIdMsg?.classList.add('hidden');
            cardContainer?.classList.remove('hidden');
            if (printBtn) printBtn.disabled = false;
        } else {
            noIdMsg?.classList.remove('hidden');
            cardContainer?.classList.add('hidden');
            if (printBtn) printBtn.disabled = true;
        }
    }

    function populateIdCardFromRow(row) {
        var data = extractRowCardData(row);
        if (!data) return null;
        applyIdCardData(data);
        return data;
    }

    window.populateIdCardFromRow = populateIdCardFromRow;

    function openIdModal(empId) {
        var modal = getIdEl('idCardModal');
        if (!modal) return;

        var row = document.querySelector('.employee-row[data-emp-id="' + empId + '"]');
        var flipInner = getIdEl('idCardInner');

        idCardFlipped = false;
        if (flipInner) flipInner.style.transform = 'rotateY(0deg)';

        var data = populateIdCardFromRow(row);
        if (!data) {
            setIdText('idCardModalTitle', 'Employee ID');
            toggleIdCardAvailability(false);
        } else {
            toggleIdCardAvailability(data.hasPhoto);
        }

        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    window.openIdModal = openIdModal;

    function closeIdModal() {
        document.getElementById('idCardModal')?.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    document.getElementById('idCardFlipContainer')?.addEventListener('click', function () {
        if (document.getElementById('idCardNoIdMessage')?.classList.contains('hidden') === false) return;
        idCardFlipped = !idCardFlipped;
        var inner = document.getElementById('idCardInner');
        if (inner) inner.style.transform = idCardFlipped ? 'rotateY(180deg)' : 'rotateY(0deg)';
    });
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="~/js/employee-id-pdf.js" asp-append-version="true"></script>
<script>
    if (window.EmployeeIdPdf && window.getSelectedEmpIds && window.openIdModal) {
        window.EmployeeIdPdf.init({ getSelectedEmpIds: window.getSelectedEmpIds, openIdModal: window.openIdModal });
    }
</script>

<script>
    function openViewModal(id) {
        var modal = document.getElementById('viewModal');
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        function set(elId, val) {
            var el = document.getElementById(elId);
            if (el) el.textContent = (val != null && val !== '') ? val : '—';
        }

        set('viewName', 'Loading…');
        set('viewEmpNumber', '');
        set('viewEmail', '');
        set('viewAge', '');
        set('viewGender', '');
        set('viewRole', '');
        set('viewDepartment', '');
        set('viewStatus', '');
        set('viewEmploymentType', '');
        set('viewJoined', '');
        set('viewAddressLine1', '');
        set('viewAddressLine2', '');
        set('viewCity', '');
        set('viewStateProvince', '');
        set('viewPostalCode', '');
        set('viewCountry', '');
        set('viewPhone', '');
        set('viewEcName', '');
        set('viewEcPhone', '');
        set('viewEcRelation', '');

        fetch('/App/Employee/EmployeeManagement?handler=Employee&id=' + encodeURIComponent(id), { headers: { 'Accept': 'application/json' } })
            .then(function (r) { return r.json(); })
            .then(function (emp) {
                if (!emp) return;

                var e = emp;
                var fn = e.FirstName || e.firstName || '';
                var mn = e.MiddleName || e.middleName || '';
                var ln = e.LastName || e.lastName || '';
                var fullName = [fn, mn, ln].filter(Boolean).join(' ') || '—';

                var dateHired = e.DateHired || e.dateHired;
                var dateStr = dateHired ? (typeof dateHired === 'string' ? dateHired.substring(0, 10) : '') : '';

                set('viewName', fullName);
                set('viewEmpNumber', e.EmpNumber || e.empNumber);
                set('viewEmail', e.Email || e.email);
                set('viewAge', e.Age != null ? e.Age : e.age);
                set('viewGender', e.Gender || e.gender);
                set('viewRole', e.Role || e.role);
                set('viewDepartment', e.DepartmentName || e.departmentName);
                set('viewStatus', e.WorkState || e.workState);
                set('viewEmploymentType', e.EmploymentType || e.employmentType);
                set('viewJoined', dateStr);
                set('viewAddressLine1', e.AddressLine1 || e.addressLine1);
                set('viewAddressLine2', e.AddressLine2 || e.addressLine2);
                set('viewCity', e.City || e.city);
                set('viewStateProvince', e.StateProvince || e.stateProvince);
                set('viewPostalCode', e.PostalCode || e.postalCode);
                set('viewCountry', e.Country || e.country);
                set('viewPhone', e.Phone || e.phone);
                set('viewEcName', e.EmergencyContactName || e.emergencyContactName);
                set('viewEcPhone', e.EmergencyContactPhone || e.emergencyContactPhone);
                set('viewEcRelation', e.EmergencyContactRelation || e.emergencyContactRelation);
            })
            .catch(function () { set('viewName', 'Failed to load.'); });
    }

    function closeViewModal() {
        document.getElementById('viewModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function openEditModal(id) {
        document.getElementById('editEmpID').value = id;
        document.getElementById('editModal').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');

        fetch('/App/Employee/EmployeeManagement?handler=Employee&id=' + encodeURIComponent(id), { headers: { 'Accept': 'application/json' } })
            .then(function (r) { return r.json(); })
            .then(function (e) {
                if (!e) return;

                document.getElementById('editFirstName').value = (e.FirstName || e.firstName) || '';
                document.getElementById('editMiddleName').value = (e.MiddleName || e.middleName) || '';
                document.getElementById('editLastName').value = (e.LastName || e.lastName) || '';
                document.getElementById('editEmpNumber').value = (e.EmpNumber || e.empNumber) || '';

                var deptId = e.DepartmentID != null ? e.DepartmentID : e.departmentID;
                document.getElementById('editDepartmentID').value = deptId != null ? String(deptId) : '';

                var roleEl = document.getElementById('editRole');
                if (roleEl) roleEl.value = (e.Role || e.role) || 'Employee';

                document.getElementById('editEmploymentType').value = (e.EmploymentType || e.employmentType) || 'Regular';

                var workStateEl = document.getElementById('editWorkState');
                if (workStateEl) workStateEl.value = (e.WorkState || e.workState) || 'Active';

                var ageVal = e.Age != null ? e.Age : e.age;
                document.getElementById('editAge').value = ageVal != null ? ageVal : '';

                document.getElementById('editGender').value = (e.Gender || e.gender) || '';

                var dh = e.DateHired || e.dateHired;
                document.getElementById('editDateHired').value = dh ? (typeof dh === 'string' ? dh.substring(0, 10) : '') : '';

                document.getElementById('editAddressLine1').value = (e.AddressLine1 || e.addressLine1) || '';
                document.getElementById('editAddressLine2').value = (e.AddressLine2 || e.addressLine2) || '';
                document.getElementById('editCity').value = (e.City || e.city) || '';
                document.getElementById('editStateProvince').value = (e.StateProvince || e.stateProvince) || '';
                document.getElementById('editPostalCode').value = (e.PostalCode || e.postalCode) || '';
                document.getElementById('editCountry').value = (e.Country || e.country) || '';
                document.getElementById('editPhone').value = (e.Phone || e.phone) || '';
                document.getElementById('editEmergencyContactName').value = (e.EmergencyContactName || e.emergencyContactName) || '';
                document.getElementById('editEmergencyContactPhone').value = (e.EmergencyContactPhone || e.emergencyContactPhone) || '';
                document.getElementById('editEmergencyContactRelation').value = (e.EmergencyContactRelation || e.emergencyContactRelation) || '';
            })
            .catch(function () { });
    }

    function closeEditModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
</script>

<script>
    var loadingHtml = '<span class="inline-flex items-center gap-2"><svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Processing…</span>';

    function setSubmitButtonLoading(btn) {
        if (!btn || btn.disabled) return;
        btn.disabled = true;
        btn.dataset.originalText = btn.textContent;
        btn.innerHTML = loadingHtml;
    }

    document.getElementById('workStateForm')?.addEventListener('submit', function () {
        document.body.classList.remove('overflow-hidden');
        setSubmitButtonLoading(document.getElementById('workStateSubmitBtn'));
    });

    document.getElementById('archiveForm')?.addEventListener('submit', function () {
        document.body.classList.remove('overflow-hidden');
        setSubmitButtonLoading(document.getElementById('archiveSubmitBtn'));
    });

    document.getElementById('editEmployeeForm')?.addEventListener('submit', function () {
        setSubmitButtonLoading(document.getElementById('editEmployeeSubmitBtn'));
    });
</script>

@{
    var toastMessage = TempData["ToastMessage"] as string;
    var toastSuccess = TempData["ToastSuccess"] as bool?;
    var toastFromQuery = Request.Query["toast"].FirstOrDefault();
    if (toastFromQuery == "success" && toastMessage == null) { toastMessage = "Employee created successfully."; toastSuccess = true; }
}
@if (toastMessage != null)
{
    <script>
        (function () {
            if (window.showToast) window.showToast(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(toastMessage)), @(toastSuccess == true ? "true" : "false"));
        })();
    </script>
}
