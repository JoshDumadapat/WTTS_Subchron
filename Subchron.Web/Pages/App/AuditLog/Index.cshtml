@page
@model Subchron.Web.Pages.App.AuditLog.IndexModel
@{
    ViewData["Title"] = "Audit Log";
    ViewData["PageTitle"] = "Audit Log";
    Layout = "/Pages/App/Shared/_LayoutAdmin.cshtml";
}

<div class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
    <div class="mb-6">
        <h1 class="text-xl font-semibold tracking-tight text-slate-800 dark:text-white sm:text-2xl">Audit Log</h1>
        <p class="mt-1 text-sm text-slate-600 dark:text-slate-400">Track logins, logouts, failed attempts, and department changes. Who did what and when.</p>
    </div>

    <div class="mb-6 rounded-2xl border border-slate-200 bg-white p-5 dark:border-slate-700 dark:bg-slate-800">
        <form method="get" id="auditLogFilterForm" class="space-y-4">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6">
                <div class="sm:col-span-2 lg:col-span-1">
                    <label for="auditLogSearch" class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">Search</label>
                    <input type="text" id="auditLogSearch" name="search" value="@Model.SearchFilter" placeholder="User, action, entity, details…" class="h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm text-slate-800 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="from" class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">From date</label>
                    <input type="date" id="from" name="from" value="@Model.FromDate" class="h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm text-slate-800 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="to" class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">To date</label>
                    <input type="date" id="to" name="to" value="@Model.ToDate" class="h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm text-slate-800 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="action" class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">Action</label>
                    <select id="action" name="action" class="h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm text-slate-700 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <option value="" selected="@(string.IsNullOrEmpty(Model.ActionFilter) ? "selected" : null)">All actions</option>
                        <option value="Login" selected="@(Model.ActionFilter == "Login" ? "selected" : null)">Login</option>
                        <option value="Logout" selected="@(Model.ActionFilter == "Logout" ? "selected" : null)">Logout</option>
                        <option value="LoginFailed" selected="@(Model.ActionFilter == "LoginFailed" ? "selected" : null)">Login Failed</option>
                        <option value="DepartmentCreated" selected="@(Model.ActionFilter == "DepartmentCreated" ? "selected" : null)">Department Created</option>
                        <option value="DepartmentUpdated" selected="@(Model.ActionFilter == "DepartmentUpdated" ? "selected" : null)">Department Updated</option>
                        <option value="DepartmentActivated" selected="@(Model.ActionFilter == "DepartmentActivated" ? "selected" : null)">Department Activated</option>
                        <option value="DepartmentDeactivated" selected="@(Model.ActionFilter == "DepartmentDeactivated" ? "selected" : null)">Department Deactivated</option>
                        <option value="EmployeeCreated" selected="@(Model.ActionFilter == "EmployeeCreated" ? "selected" : null)">Employee Created</option>
                        <option value="EmployeeUpdated" selected="@(Model.ActionFilter == "EmployeeUpdated" ? "selected" : null)">Employee Updated</option>
                        <option value="EmployeeArchived" selected="@(Model.ActionFilter == "EmployeeArchived" ? "selected" : null)">Employee Archived</option>
                        <option value="EmployeeRestored" selected="@(Model.ActionFilter == "EmployeeRestored" ? "selected" : null)">Employee Restored</option>
                    </select>
                </div>
                <div>
                    <label for="entityName" class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">Entity type</label>
                    <select id="entityName" name="entityName" class="h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm text-slate-700 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <option value="" selected="@(string.IsNullOrEmpty(Model.EntityFilter) ? "selected" : null)">All entities</option>
                        <option value="User" selected="@(Model.EntityFilter == "User" ? "selected" : null)">User</option>
                        <option value="Department" selected="@(Model.EntityFilter == "Department" ? "selected" : null)">Department</option>
                        <option value="Employee" selected="@(Model.EntityFilter == "Employee" ? "selected" : null)">Employee</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button type="submit"
                            class="h-10 rounded-xl bg-subgreen-600 px-4 text-sm font-semibold text-white hover:bg-subgreen-500">
                        Apply
                    </button>

                    <a href="/App/AuditLog"
                       class="inline-flex h-10 items-center justify-center rounded-xl border border-slate-300 bg-white px-4 text-sm font-medium text-slate-700 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">
                        Reset
                    </a>
                </div>
            </div>
        </form>
    </div>

    <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-900">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead>
                    <tr class="border-y border-slate-100 bg-slate-50/50 dark:border-slate-800 dark:bg-slate-900/50">
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Date &amp; Time</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">User</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Action</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Record Type</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Record ID</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Summary</th>
                    </tr>
                </thead>
                <tbody id="auditLogTableBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                    <tr id="auditLogLoadingRow">
                        <td colspan="6" class="px-5 py-8 text-center text-slate-500 dark:text-slate-400">
                            <span class="inline-flex items-center gap-2"><svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Loading…</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="auditLogFooter" class="flex flex-col gap-3 border-t border-slate-100 px-5 py-4 sm:flex-row sm:items-center sm:justify-between dark:border-slate-800 dark:bg-slate-900">
            <div class="flex flex-wrap items-center gap-3">
                <p class="text-sm text-slate-600 dark:text-slate-400">Showing <span id="auditLogRange">0–0</span> of <span id="auditLogTotal">0</span></p>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium uppercase text-slate-500 dark:text-slate-400">Rows</span>
                    <select id="auditLogPageSize" class="h-8 rounded-lg border border-slate-200 bg-white px-2 text-sm font-medium text-slate-600 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200">
                        <option value="10">10</option>
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="auditLogPageOf" class="text-sm text-slate-500 dark:text-slate-400">Page 1 of 1</span>
                <a id="auditLogPrev" href="#" class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-800" aria-label="Previous" style="display:none;">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </a>
                <a id="auditLogNext" href="#" class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-800" aria-label="Next" style="display:none;">
                    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Audit log detail modal (row click) -->
<div id="auditLogDetailModal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
    <div class="flex min-h-screen items-center justify-center p-4">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeAuditLogDetailModal()"></div>
        <div class="relative w-full max-w-lg rounded-2xl border border-slate-200 bg-white shadow-2xl dark:border-slate-700 dark:bg-slate-900">
            <div class="border-b border-slate-100 px-6 py-4 dark:border-slate-800">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Audit log entry</h3>
            </div>
            <div class="max-h-[70vh] overflow-y-auto px-6 py-4 space-y-6">
                <section>
                    <h4 class="mb-3 text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Event Information</h4>
                    <dl class="space-y-2 text-sm">
                        <div><dt class="text-xs text-slate-500 dark:text-slate-400">Date &amp; Time</dt><dd id="detailCreatedAt" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                        <div><dt class="text-xs text-slate-500 dark:text-slate-400">User</dt><dd id="detailUserName" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                        <div><dt class="text-xs text-slate-500 dark:text-slate-400">Action</dt><dd id="detailAction" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                        <div><dt class="text-xs text-slate-500 dark:text-slate-400">Record Type</dt><dd id="detailEntityName" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                        <div><dt class="text-xs text-slate-500 dark:text-slate-400">Record ID</dt><dd id="detailEntityId" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                    </dl>
                </section>
                <section>
                    <h4 class="mb-3 text-xs font-semibold uppercase tracking-wider text-slate-500 dark:text-slate-400">Details</h4>
                    <p id="detailDetails" class="text-sm text-slate-800 dark:text-slate-200">—</p>
                </section>
                <section>
                    <button type="button" id="auditLogTechnicalToggle" class="flex w-full items-center justify-between rounded-lg border border-slate-200 bg-slate-50/50 px-4 py-3 text-left text-sm font-medium text-slate-700 hover:bg-slate-100 dark:border-slate-700 dark:bg-slate-800/50 dark:text-slate-200 dark:hover:bg-slate-800" aria-expanded="false">
                        <span>Technical Information</span>
                        <svg id="auditLogTechnicalChevron" class="h-4 w-4 text-slate-500 transition-transform dark:text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                    </button>
                    <div id="auditLogTechnicalContent" class="hidden border border-t-0 border-slate-200 dark:border-slate-700 rounded-b-lg border-x px-4 py-3 dark:bg-slate-800/30">
                        <dl class="space-y-2 text-sm">
                            <div><dt class="text-xs text-slate-500 dark:text-slate-400">IP Address</dt><dd id="detailIpAddress" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                            <div><dt class="text-xs text-slate-500 dark:text-slate-400">User Agent</dt><dd id="detailUserAgent" class="mt-0.5 break-all text-slate-800 dark:text-slate-200">—</dd></div>
                        </dl>
                    </div>
                </section>
            </div>
            <div class="border-t border-slate-100 px-6 py-4 dark:border-slate-800">
                <button type="button" onclick="closeAuditLogDetailModal()" class="rounded-xl border border-slate-300 bg-white px-4 py-2 text-sm font-medium text-slate-600 hover:bg-slate-50 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-300">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
(function () {
    var tbody = document.getElementById('auditLogTableBody');
    var loadingRow = document.getElementById('auditLogLoadingRow');
    if (!tbody) return;
    function buildParams() {
        var params = new URLSearchParams(window.location.search);
        params.set('handler', 'Data');
        params.set('page', params.get('page') || '1');
        var sel = document.getElementById('auditLogPageSize');
        params.set('pageSize', (sel && sel.value) || params.get('pageSize') || '50');
        if (params.get('search') !== undefined) { /* keep from URL */ }
        return params;
    }
    function formatDateTable(d) {
        if (!d) return '—';
        var dt = new Date(d);
        if (isNaN(dt.getTime())) return '—';
        var mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()];
        var day = dt.getDate();
        var year = dt.getFullYear();
        var h = dt.getHours();
        var m = dt.getMinutes();
        var am = h < 12 ? 'AM' : 'PM';
        h = h % 12 || 12;
        var min = m < 10 ? '0' + m : m;
        return mon + ' ' + day + ', ' + year + ' ' + h + ':' + min + am;
    }
    function formatDateModal(d) {
        if (!d) return '—';
        var dt = new Date(d);
        if (isNaN(dt.getTime())) return '—';
        var mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][dt.getMonth()];
        var day = dt.getDate();
        var year = dt.getFullYear();
        var h = dt.getHours();
        var m = dt.getMinutes();
        var am = h < 12 ? 'AM' : 'PM';
        h = h % 12 || 12;
        var min = m < 10 ? '0' + m : m;
        return mon + ' ' + day + ', ' + year + ' • ' + h + ':' + min + ' ' + am;
    }
    function actionLabel(action) {
        if (!action) return '—';
        var map = { 'EmployeeCreated':'Created','EmployeeUpdated':'Updated','EmployeeArchived':'Archived','EmployeeRestored':'Restored','DepartmentCreated':'Created','DepartmentUpdated':'Updated','DepartmentActivated':'Activated','DepartmentDeactivated':'Deactivated','Login':'Login','Logout':'Logout','LoginFailed':'Login Failed' };
        return map[action] || action;
    }
    function actionClass(action) {
        if (action === 'EmployeeArchived' || action === 'EmployeeRestored') return 'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300';
        if (action === 'EmployeeUpdated' || action === 'EmployeeCreated') return 'bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-300';
        if (action === 'Login') return 'bg-subgreen-50 text-subgreen-700 dark:bg-subgreen-900/30 dark:text-subgreen-300';
        if (action === 'Logout') return 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300';
        if (action === 'LoginFailed') return 'bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-300';
        if (action && action.indexOf('Department') === 0) return 'bg-sky-50 text-sky-700 dark:bg-sky-900/30 dark:text-sky-300';
        return 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300';
    }
    function esc(s) { if (s == null || s === undefined) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
    function openAuditLogDetailModal(log) {
        document.getElementById('detailCreatedAt').textContent = log.createdAt ? formatDateModal(log.createdAt) : '—';
        document.getElementById('detailUserName').textContent = log.userName || (log.userID != null ? 'User #' + log.userID : '—');
        document.getElementById('detailAction').textContent = actionLabel(log.action) || '—';
        document.getElementById('detailEntityName').textContent = log.entityName || '—';
        document.getElementById('detailEntityId').textContent = log.entityID != null ? String(log.entityID) : '—';
        document.getElementById('detailDetails').textContent = log.details || '—';
        document.getElementById('detailIpAddress').textContent = log.ipAddress || '—';
        document.getElementById('detailUserAgent').textContent = log.userAgent || '—';
        document.getElementById('auditLogTechnicalContent').classList.add('hidden');
        document.getElementById('auditLogTechnicalChevron').classList.remove('rotate-180');
        document.getElementById('auditLogDetailModal').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }
    document.getElementById('auditLogTechnicalToggle')?.addEventListener('click', function () {
        var content = document.getElementById('auditLogTechnicalContent');
        var chevron = document.getElementById('auditLogTechnicalChevron');
        content.classList.toggle('hidden');
        chevron.classList.toggle('rotate-180');
        this.setAttribute('aria-expanded', content.classList.contains('hidden') ? 'false' : 'true');
    });
    window.closeAuditLogDetailModal = function () {
        document.getElementById('auditLogDetailModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    };
    function loadAuditLog() {
        var params = buildParams();
        fetch('/App/AuditLog?' + params.toString(), { headers: { 'Accept': 'application/json' } })
            .then(function (r) { return r.json(); })
            .then(function (data) {
                if (loadingRow) loadingRow.remove();
                var logs = data.logs || [];
                var total = data.totalCount || 0;
                var page = parseInt(params.get('page') || '1', 10);
                var pageSize = parseInt(params.get('pageSize') || '50', 10);
                var totalPages = Math.max(1, Math.ceil(total / pageSize));
                tbody.innerHTML = '';
                if (logs.length === 0) {
                    tbody.insertAdjacentHTML('beforeend', '<tr><td colspan="6" class="px-5 py-8 text-center text-slate-600 dark:text-slate-400">No audit entries found.</td></tr>');
                } else {
                    logs.forEach(function (log) {
                        var date = formatDateTable(log.createdAt);
                        var user = log.userName || (log.userID ? 'User #' + log.userID : '—');
                        var action = log.action || '—';
                        var actionDisplay = actionLabel(action);
                        var recordType = log.entityName || '—';
                        var recordId = log.entityID != null ? '#' + log.entityID : '—';
                        var summary = log.details || '—';
                        var tr = document.createElement('tr');
                        tr.className = 'cursor-pointer hover:bg-slate-50/50 dark:hover:bg-slate-800/50';
                        try { tr.setAttribute('data-log', JSON.stringify(log)); } catch (e) { tr.setAttribute('data-log', '{}'); }
                        tr.innerHTML = '<td class="whitespace-nowrap px-5 py-3 text-slate-700 dark:text-slate-300">' + esc(date) + '</td><td class="px-5 py-3 text-slate-700 dark:text-slate-300">' + esc(user) + '</td><td class="px-5 py-3"><span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ' + actionClass(action) + '">' + esc(actionDisplay) + '</span></td><td class="px-5 py-3 text-slate-600 dark:text-slate-400">' + esc(recordType) + '</td><td class="px-5 py-3 text-slate-600 dark:text-slate-400">' + esc(recordId) + '</td><td class="max-w-[280px] truncate px-5 py-3 text-slate-600 dark:text-slate-400" title="' + esc(summary) + '">' + esc(summary) + '</td>';
                        tr.addEventListener('click', function () {
                            try {
                                var data = JSON.parse(this.getAttribute('data-log') || '{}');
                                openAuditLogDetailModal(data);
                            } catch (e) { }
                        });
                        tbody.appendChild(tr);
                    });
                }
                var start = total === 0 ? 0 : (page - 1) * pageSize + 1;
                var end = total === 0 ? 0 : Math.min(page * pageSize, total);
                var rangeEl = document.getElementById('auditLogRange');
                var totalEl = document.getElementById('auditLogTotal');
                if (rangeEl) rangeEl.textContent = start + '–' + end;
                if (totalEl) totalEl.textContent = total;
                var pageOfEl = document.getElementById('auditLogPageOf');
                if (pageOfEl) pageOfEl.textContent = 'Page ' + page + ' of ' + totalPages;
                var base = '?pageSize=' + pageSize + (params.get('from') ? '&from=' + params.get('from') : '') + (params.get('to') ? '&to=' + params.get('to') : '') + (params.get('action') ? '&action=' + encodeURIComponent(params.get('action')) : '') + (params.get('entityName') ? '&entityName=' + encodeURIComponent(params.get('entityName')) : '') + (params.get('search') ? '&search=' + encodeURIComponent(params.get('search')) : '');
                var prevEl = document.getElementById('auditLogPrev');
                var nextEl = document.getElementById('auditLogNext');
                if (prevEl) {
                    prevEl.style.display = page > 1 ? '' : 'none';
                    prevEl.href = page > 1 ? '#' : '#';
                    prevEl.onclick = function (e) {
                        if (page <= 1) return;
                        e.preventDefault();
                        var params = new URLSearchParams(window.location.search);
                        params.set('page', String(page - 1));
                        window.history.replaceState({}, '', '/App/AuditLog?' + params.toString());
                        loadAuditLog();
                    };
                }
                if (nextEl) {
                    nextEl.style.display = page < totalPages ? '' : 'none';
                    nextEl.href = page >= totalPages ? '#' : '#';
                    nextEl.onclick = function (e) {
                        if (page >= totalPages) return;
                        e.preventDefault();
                        var params = new URLSearchParams(window.location.search);
                        params.set('page', String(page + 1));
                        window.history.replaceState({}, '', '/App/AuditLog?' + params.toString());
                        loadAuditLog();
                    };
                }
                var sel = document.getElementById('auditLogPageSize');
                if (sel) sel.value = String(pageSize);
            })
            .catch(function () {
                if (loadingRow) loadingRow.remove();
                tbody.innerHTML = '';
                tbody.insertAdjacentHTML('beforeend', '<tr><td colspan="6" class="px-5 py-8 text-center text-red-600 dark:text-red-400">Failed to load audit log.</td></tr>');
            });
    }
    var pageSizeEl = document.getElementById('auditLogPageSize');
    if (pageSizeEl) {
        pageSizeEl.value = new URLSearchParams(window.location.search).get('pageSize') || '50';
        pageSizeEl.addEventListener('change', function () {
            var params = new URLSearchParams(window.location.search);
            params.set('pageSize', this.value);
            params.set('page', '1');
            params.delete('handler');
            var url = '/App/AuditLog?' + params.toString();
            window.location.href = url;
        });
    }
    loadAuditLog();
})();
</script>
