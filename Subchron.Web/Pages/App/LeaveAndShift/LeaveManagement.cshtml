@page
@model Subchron.Web.Pages.App.LeaveAndShift.LeaveManagementModel
@{
    ViewData["Title"] = "Leave Management";
    ViewData["PageTitle"] = "Leave Management";
    Layout = "/Pages/App/Shared/_LayoutAdmin.cshtml";
}

<div class="mx-auto">
    <div class="mb-6 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
        <div>
            <h1 class="text-xl font-bold tracking-tight text-subgreen-500 dark:text-white sm:text-2xl">Leave Management</h1>
        </div>
    </div>

    <div class="mb-6 rounded-2xl border border-slate-200 bg-white p-5 dark:border-slate-700 dark:bg-slate-800">
        <form method="get" id="leaveFilterForm" class="space-y-4">
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-6">
                <div class="sm:col-span-2 lg:col-span-1">
                    <label for="leaveSearch" class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">Search</label>
                    <input type="text" id="leaveSearch" name="search" value="@Model.SearchFilter" placeholder="Employee name or number…" class="h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm text-slate-800 dark:border-slate-600 dark:bg-slate-700 dark:text-white" />
                </div>
                <div>
                    <label for="status" class="mb-1 block text-xs font-medium text-slate-600 dark:text-slate-400">Status</label>
                    <select id="status" name="status" class="h-10 w-full rounded-xl border border-slate-200 bg-white px-3 text-sm text-slate-700 dark:border-slate-600 dark:bg-slate-700 dark:text-white">
                        <option value="" selected="@(string.IsNullOrEmpty(Model.StatusFilter) ? "selected" : null)">All</option>
                        <option value="Pending" selected="@(Model.StatusFilter == "Pending" ? "selected" : null)">Pending</option>
                        <option value="Approved" selected="@(Model.StatusFilter == "Approved" ? "selected" : null)">Approved</option>
                        <option value="Declined" selected="@(Model.StatusFilter == "Declined" ? "selected" : null)">Declined</option>
                    </select>
                </div>
                <div class="flex items-end gap-2">
                    <button type="submit" class="btn-primary h-10 px-4">Apply</button>
                    <a href="/App/LeaveAndShift/LeaveManagement" class="btn-secondary h-10 px-4">Reset</a>
                </div>
            </div>
        </form>
    </div>

    <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white shadow-sm dark:border-slate-700 dark:bg-slate-900">
        <div class="overflow-x-auto">
            <table class="w-full text-left text-sm">
                <thead>
                    <tr class="border-y border-slate-100 bg-slate-50/50 dark:border-slate-800 dark:bg-slate-900/50">
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Employee</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Leave Type</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Start</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">End</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Status</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Submitted</th>
                        <th class="px-5 py-3 text-xs font-semibold uppercase tracking-wider text-slate-600 dark:text-slate-300">Actions</th>
                    </tr>
                </thead>
                <tbody id="leaveTableBody" class="divide-y divide-slate-100 dark:divide-slate-800">
                    <tr id="leaveLoadingRow">
                        <td colspan="7" class="px-5 py-8 text-center text-slate-500 dark:text-slate-400">
                            <span class="inline-flex items-center gap-2"><svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Loading…</span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div id="leaveFooter" class="flex flex-col gap-3 border-t border-slate-100 px-5 py-4 sm:flex-row sm:items-center sm:justify-between dark:border-slate-800 dark:bg-slate-900">
            <div class="flex flex-wrap items-center gap-3">
                <p class="text-sm text-slate-600 dark:text-slate-400">Showing <span id="leaveRange">0–0</span> of <span id="leaveTotal">0</span></p>
                <div class="flex items-center gap-2">
                    <span class="text-xs font-medium uppercase text-slate-500 dark:text-slate-400">Rows</span>
                    <select id="leavePageSize" class="h-8 rounded-lg border border-slate-200 bg-white px-2 text-sm font-medium text-slate-600 dark:border-slate-600 dark:bg-slate-800 dark:text-slate-200">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                    </select>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <span id="leavePageOf" class="text-sm text-slate-500 dark:text-slate-400">Page 1 of 1</span>
                <a id="leavePrev" href="#" class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-800" aria-label="Previous" style="display:none;">&larr;</a>
                <a id="leaveNext" href="#" class="inline-flex h-8 w-8 items-center justify-center rounded-lg border border-slate-200 text-slate-600 hover:bg-slate-50 dark:border-slate-600 dark:text-slate-300 dark:hover:bg-slate-800" aria-label="Next" style="display:none;">&rarr;</a>
            </div>
        </div>
    </div>
</div>

<!-- Detail modal -->
<div id="leaveDetailModal" class="fixed inset-0 z-50 hidden overflow-y-auto" role="dialog" aria-modal="true">
    <div class="flex min-h-screen items-center justify-center p-4">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeLeaveDetailModal()"></div>
        <div class="relative w-full max-w-lg rounded-2xl border border-slate-200 bg-white shadow-2xl dark:border-slate-700 dark:bg-slate-900">
            <div class="border-b border-slate-100 px-6 py-4 dark:border-slate-800">
                <h3 class="text-lg font-semibold text-slate-900 dark:text-white">Leave request details</h3>
            </div>
            <div class="max-h-[70vh] overflow-y-auto px-6 py-4 space-y-4">
                <dl class="grid grid-cols-1 gap-3 text-sm">
                    <div><dt class="text-xs text-slate-500 dark:text-slate-400">Employee</dt><dd id="detailEmployeeName" class="mt-0.5 font-medium text-slate-800 dark:text-slate-200">—</dd></div>
                    <div><dt class="text-xs text-slate-500 dark:text-slate-400">Leave type</dt><dd id="detailLeaveType" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                    <div><dt class="text-xs text-slate-500 dark:text-slate-400">Start date</dt><dd id="detailStartDate" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                    <div><dt class="text-xs text-slate-500 dark:text-slate-400">End date</dt><dd id="detailEndDate" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                    <div><dt class="text-xs text-slate-500 dark:text-slate-400">Status</dt><dd id="detailStatus" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                    <div><dt class="text-xs text-slate-500 dark:text-slate-400">Reason</dt><dd id="detailReason" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                    <div><dt class="text-xs text-slate-500 dark:text-slate-400">Reviewed by</dt><dd id="detailReviewedBy" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                    <div><dt class="text-xs text-slate-500 dark:text-slate-400">Review notes</dt><dd id="detailReviewNotes" class="mt-0.5 text-slate-800 dark:text-slate-200">—</dd></div>
                </dl>
                <div id="leaveDetailActions" class="flex gap-2 pt-2 border-t border-slate-100 dark:border-slate-800 hidden">
                    <form method="post" asp-page-handler="Approve" id="leaveApproveForm" class="inline">
                        <input type="hidden" name="id" id="leaveApproveId" value="" />
                        <input type="hidden" name="notes" id="leaveApproveNotes" value="" />
                        <button type="submit" class="btn-primary px-4">Approve</button>
                    </form>
                    <form method="post" asp-page-handler="Decline" id="leaveDeclineForm" class="inline">
                        <input type="hidden" name="id" id="leaveDeclineId" value="" />
                        <input type="hidden" name="notes" id="leaveDeclineNotes" value="" />
                        <button type="submit" class="rounded-xl border border-red-300 bg-white px-4 py-2.5 text-sm font-semibold text-red-700 hover:bg-red-50 dark:border-red-700 dark:bg-slate-800 dark:text-red-300">Decline</button>
                    </form>
                </div>
            </div>
            <div class="border-t border-slate-100 px-6 py-4 dark:border-slate-800">
                <button type="button" onclick="closeLeaveDetailModal()" class="btn-secondary px-4 py-2">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
(function () {
    var tbody = document.getElementById('leaveTableBody');
    var loadingRow = document.getElementById('leaveLoadingRow');
    if (!tbody) return;

    function buildParams() {
        var params = new URLSearchParams(window.location.search);
        params.set('handler', 'Data');
        params.set('page', params.get('page') || '1');
        var sel = document.getElementById('leavePageSize');
        params.set('pageSize', (sel && sel.value) || params.get('pageSize') || '25');
        if (params.get('status') !== undefined) { /* keep */ }
        if (params.get('search') !== undefined) { /* keep */ }
        return params;
    }

    function formatDate(d) {
        if (!d) return '—';
        var dt = new Date(d);
        if (isNaN(dt.getTime())) return '—';
        return dt.toLocaleDateString(undefined, { year: 'numeric', month: 'short', day: 'numeric' });
    }

    function statusClass(s) {
        if (s === 'Pending') return 'bg-amber-100 text-amber-800 dark:bg-amber-900/40 dark:text-amber-300';
        if (s === 'Approved') return 'bg-subgreen-100 text-subgreen-800 dark:bg-subgreen-900/40 dark:text-subgreen-300';
        if (s === 'Declined') return 'bg-red-100 text-red-800 dark:bg-red-900/40 dark:text-red-300';
        return 'bg-slate-100 text-slate-700 dark:bg-slate-700 dark:text-slate-300';
    }

    function esc(s) { if (s == null || s === undefined) return ''; return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }

    window.openLeaveDetailModal = function (item) {
        document.getElementById('detailEmployeeName').textContent = (item.employeeName || item.empNumber || '—');
        document.getElementById('detailLeaveType').textContent = item.leaveType || '—';
        document.getElementById('detailStartDate').textContent = formatDate(item.startDate);
        document.getElementById('detailEndDate').textContent = formatDate(item.endDate);
        document.getElementById('detailStatus').textContent = item.status || '—';
        document.getElementById('detailReason').textContent = item.reason || '—';
        document.getElementById('detailReviewedBy').textContent = item.reviewedByUserName || '—';
        document.getElementById('detailReviewNotes').textContent = item.reviewNotes || '—';

        var actions = document.getElementById('leaveDetailActions');
        var approveForm = document.getElementById('leaveApproveForm');
        var declineForm = document.getElementById('leaveDeclineForm');
        if (item.status === 'Pending') {
            actions.classList.remove('hidden');
            document.getElementById('leaveApproveId').value = item.leaveRequestID;
            document.getElementById('leaveDeclineId').value = item.leaveRequestID;
        } else {
            actions.classList.add('hidden');
        }

        document.getElementById('leaveDetailModal').classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    };

    window.closeLeaveDetailModal = function () {
        document.getElementById('leaveDetailModal').classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    };

    function loadLeave() {
        var params = buildParams();
        fetch('/App/LeaveAndShift/LeaveManagement?' + params.toString(), { headers: { 'Accept': 'application/json' } })
            .then(function (r) { return r.json(); })
            .then(function (data) {
                if (loadingRow) loadingRow.remove();
                var items = data.items || [];
                var total = data.totalCount || 0;
                var page = parseInt(data.page || '1', 10);
                var pageSize = parseInt(data.pageSize || '25', 10);
                var totalPages = Math.max(1, Math.ceil(total / pageSize));
                tbody.innerHTML = '';
                if (items.length === 0) {
                    tbody.insertAdjacentHTML('beforeend', '<tr><td colspan="7" class="px-5 py-8 text-center text-slate-600 dark:text-slate-400">No leave requests found.</td></tr>');
                } else {
                    items.forEach(function (item) {
                        var tr = document.createElement('tr');
                        tr.className = 'cursor-pointer hover:bg-slate-50/50 dark:hover:bg-slate-800/50';
                        tr.setAttribute('data-item', JSON.stringify(item));
                        tr.innerHTML = '<td class="px-5 py-3 text-slate-700 dark:text-slate-300">' + esc(item.employeeName) + ' <span class="text-slate-500">' + esc(item.empNumber) + '</span></td>' +
                            '<td class="px-5 py-3 text-slate-700 dark:text-slate-300">' + esc(item.leaveType) + '</td>' +
                            '<td class="whitespace-nowrap px-5 py-3 text-slate-700 dark:text-slate-300">' + formatDate(item.startDate) + '</td>' +
                            '<td class="whitespace-nowrap px-5 py-3 text-slate-700 dark:text-slate-300">' + formatDate(item.endDate) + '</td>' +
                            '<td class="px-5 py-3"><span class="inline-flex items-center rounded-full px-2 py-0.5 text-xs font-medium ' + statusClass(item.status) + '">' + esc(item.status) + '</span></td>' +
                            '<td class="whitespace-nowrap px-5 py-3 text-slate-600 dark:text-slate-400">' + formatDate(item.createdAt) + '</td>' +
                            '<td class="px-5 py-3"><button type="button" class="text-subgreen-600 hover:underline text-sm font-medium" onclick="event.stopPropagation(); openLeaveDetailModal(' + JSON.stringify(item).replace(/"/g, '&quot;') + ')">View</button></td>';
                        tr.addEventListener('click', function (e) {
                            if (e.target.tagName === 'BUTTON') return;
                            try { openLeaveDetailModal(JSON.parse(this.getAttribute('data-item'))); } catch (err) {}
                        });
                        tbody.appendChild(tr);
                    });
                }
                var start = total === 0 ? 0 : (page - 1) * pageSize + 1;
                var end = total === 0 ? 0 : Math.min(page * pageSize, total);
                var rangeEl = document.getElementById('leaveRange');
                var totalEl = document.getElementById('leaveTotal');
                if (rangeEl) rangeEl.textContent = start + '–' + end;
                if (totalEl) totalEl.textContent = total;
                var pageOfEl = document.getElementById('leavePageOf');
                if (pageOfEl) pageOfEl.textContent = 'Page ' + page + ' of ' + totalPages;
                var base = '?pageSize=' + pageSize + (params.get('status') ? '&status=' + encodeURIComponent(params.get('status')) : '') + (params.get('search') ? '&search=' + encodeURIComponent(params.get('search')) : '');
                var prevEl = document.getElementById('leavePrev');
                var nextEl = document.getElementById('leaveNext');
                if (prevEl) { prevEl.href = page > 1 ? base + '&page=' + (page - 1) : '#'; prevEl.style.display = page > 1 ? '' : 'none'; }
                if (nextEl) { nextEl.href = page < totalPages ? base + '&page=' + (page + 1) : '#'; nextEl.style.display = page < totalPages ? '' : 'none'; }
                var sel = document.getElementById('leavePageSize');
                if (sel) sel.value = String(pageSize);
            })
            .catch(function () {
                if (loadingRow) loadingRow.remove();
                tbody.innerHTML = '';
                tbody.insertAdjacentHTML('beforeend', '<tr><td colspan="7" class="px-5 py-8 text-center text-red-600 dark:text-red-400">Failed to load leave requests.</td></tr>');
            });
    }

    var pageSizeEl = document.getElementById('leavePageSize');
    if (pageSizeEl) {
        pageSizeEl.value = new URLSearchParams(window.location.search).get('pageSize') || '25';
        pageSizeEl.addEventListener('change', function () {
            var params = new URLSearchParams(window.location.search);
            params.set('pageSize', this.value);
            params.set('page', '1');
            params.delete('handler');
            window.location.href = '/App/LeaveAndShift/LeaveManagement?' + params.toString();
        });
    }

    loadLeave();
})();
</script>
